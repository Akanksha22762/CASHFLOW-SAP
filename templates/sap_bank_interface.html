<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise SAP-Bank Reconciliation Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary-color: #059669;
            --secondary-light: #10b981;
            --accent-color: #dc2626;
            --accent-light: #ef4444;
            --warning-color: #d97706;
            --warning-light: #f59e0b;
            --success-color: #059669;
            --success-light: #10b981;
            --error-color: #dc2626;
            --error-light: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --border-color: #e5e7eb;
            --border-light: #f3f4f6;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            --gradient-secondary: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-light) 100%);
            --border-radius: 6px;
            --border-radius-lg: 8px;
            --border-radius-xl: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: #f8fafc;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header & Navigation */
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .product-name {
            font-size: 1.75rem;
            font-weight: 700;
            color: white;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .product-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            font-weight: 400;
            margin: 0;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--border-radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            font-weight: 500;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Dashboard Title Section */
        .dashboard-title-section {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .dashboard-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            font-weight: 400;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Summary Cards Section */
        .summary-cards-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-light);
        }

        .summary-cards-grid {
            display: flex;
            flex-direction: row;
            gap: 1.5rem;
            justify-content: space-between;
            align-items: stretch;
        }

        .summary-cards-grid .summary-card {
            flex: 1;
            min-width: 0;
        }

        .summary-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: var(--transition);
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-icon {
            font-size: 1.5rem;
            color: var(--primary-light);
        }

        .card-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
        }

        .card-trend.positive {
            color: var(--success-color);
        }

        .card-trend.negative {
            color: var(--error-color);
        }

        .card-content {
            padding: 1rem;
        }

        .card-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .summary-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        /* Cards & Sections */
        .section-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            border: 1px solid var(--border-light);
            overflow: hidden;
            transition: var(--transition);
        }

        .section-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .section-header {
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-number {
            background: var(--gradient-primary);
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .section-title h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .section-title p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: 0;
        }

        .section-content {
            padding: 2rem;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .grid-sm {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        /* Upload Areas */
        .upload-card {
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius-xl);
            padding: 2.5rem;
            text-align: center;
            transition: var(--transition);
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .upload-card:hover {
            border-color: var(--primary-light);
            background: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .upload-card.dragover {
            border-color: var(--success-color);
            background: rgba(5, 150, 105, 0.05);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            opacity: 0.8;
        }

        .upload-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .upload-card p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--gradient-secondary);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, var(--warning-light) 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color) 0%, var(--error-light) 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn:disabled::before {
            display: none;
        }

        .btn-sm {
            padding: 0.625rem 1.25rem;
            font-size: 0.8rem;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        /* File Info */
        .file-info {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .file-info.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-info h4 {
            color: var(--success-color);
            margin-bottom: 0.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Progress Bar */
        .progress-container {
            margin: 1.5rem 0;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Stats Cards */
        .stats-grid {
            display: flex;
            flex-direction: row;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .stats-grid .stat-card {
            flex: 1;
            min-width: 180px;
            padding: 1.5rem;
        }

        .stat-number {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
            margin-bottom: 0.5rem;
            line-height: 1.2;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        /* Horizontal Stats Grid for Dashboard */
        .stats-grid-horizontal {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            gap: 1rem;
            margin: 1.5rem 0;
            justify-content: space-between;
            align-items: stretch;
            width: 100%;
        }

        .stats-grid-horizontal .stat-card {
            flex: 1 !important;
            min-width: 0 !important;
            max-width: none !important;
            margin-bottom: 0 !important;
            width: auto !important;
        }

        @media (max-width: 768px) {
            .stats-grid-horizontal {
                flex-direction: column !important;
                flex-wrap: wrap;
            }
            
            .stats-grid-horizontal .stat-card {
                min-width: 100% !important;
                max-width: 100% !important;
            }
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: var(--border-radius-xl);
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            font-size: 2rem;
            color: var(--primary-light);
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 1rem;
        }

        /* Enhanced Animations */
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        /* Results & Tables */
        .results-section {
            display: none;
            margin-top: 2rem;
        }

        .results-section.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .data-table th {
            background: var(--bg-secondary);
            padding: 1.25rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.875rem;
            vertical-align: middle;
        }

        .data-table tr:hover {
            background: var(--bg-secondary);
            transition: background-color 0.2s ease;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .amount-positive {
            color: var(--success-color);
            font-weight: 600;
        }

        .amount-negative {
            color: var(--error-color);
            font-weight: 600;
        }

        .match-score {
            background: var(--gradient-primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Popup Alerts */
        .popup-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 400px;
            max-width: 90vw;
            padding: 1.25rem 1.75rem;
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            font-weight: 500;
            border: 1px solid;
            box-shadow: var(--shadow-xl);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            backdrop-filter: blur(10px);
        }

        .popup-alert.show {
            transform: translateX(0);
        }

        .popup-alert.success {
            background: rgba(5, 150, 105, 0.95);
            border-color: rgba(5, 150, 105, 0.3);
            color: white;
        }

        .popup-alert.error {
            background: rgba(220, 38, 38, 0.95);
            border-color: rgba(220, 38, 38, 0.3);
            color: white;
        }

        .popup-alert.info {
            background: rgba(59, 130, 246, 0.95);
            border-color: rgba(59, 130, 246, 0.3);
            color: white;
        }

        .popup-alert.warning {
            background: rgba(217, 119, 6, 0.95);
            border-color: rgba(217, 119, 6, 0.3);
            color: white;
        }

        .popup-alert i {
            font-size: 1.125rem;
            margin-top: 0.125rem;
            flex-shrink: 0;
        }

        .popup-alert .alert-content {
            flex: 1;
        }

        .popup-alert .close-alert {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            margin-left: 0.5rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .popup-alert .close-alert:hover {
            opacity: 1;
        }

        /* Legacy alert styles (keeping for compatibility) */
        .alert {
            padding: 1.25rem 1.75rem;
            border-radius: var(--border-radius-lg);
            margin: 1rem 0;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            font-weight: 500;
            border: 1px solid;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .alert-success {
            background: rgba(5, 150, 105, 0.05);
            border-color: rgba(5, 150, 105, 0.2);
            color: var(--success-color);
        }

        .alert-success::before {
            background: var(--success-color);
        }

        .alert-error {
            background: rgba(220, 38, 38, 0.05);
            border-color: rgba(220, 38, 38, 0.2);
            color: var(--error-color);
        }

        .alert-error::before {
            background: var(--error-color);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.05);
            border-color: rgba(59, 130, 246, 0.2);
            color: var(--primary-light);
        }

        .alert-info::before {
            background: var(--primary-light);
        }

        .alert-warning {
            background: rgba(217, 119, 6, 0.05);
            border-color: rgba(217, 119, 6, 0.2);
            color: var(--warning-color);
        }

        .alert-warning::before {
            background: var(--warning-color);
        }

        .alert i {
            font-size: 1.125rem;
            margin-top: 0.125rem;
        }

        /* Tabs */
        .tab-container {
            margin: 2rem 0;
        }

        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: var(--transition);
            white-space: nowrap;
            font-size: 0.875rem;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .tab-button:hover {
            color: var(--primary-light);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 1.5rem;
            }
            
            .summary-cards-grid {
                flex-wrap: wrap;
            }
            
            .summary-cards-grid .summary-card {
                flex: 1 1 calc(50% - 0.75rem);
                min-width: 200px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header-logo {
                justify-content: center;
            }

            .dashboard-title {
                font-size: 2rem;
            }

            .dashboard-subtitle {
                font-size: 1rem;
            }

            .summary-cards-section {
                padding: 1.5rem;
            }

            .summary-cards-grid {
                flex-direction: column;
                gap: 1rem;
            }
            
            .summary-cards-grid .summary-card {
                flex: 1;
                min-width: 100%;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .section-content {
                padding: 1.5rem;
            }

            .section-header {
                padding: 1.25rem 1.5rem;
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }

            .btn-group {
                flex-direction: column;
                gap: 0.75rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .tab-nav {
                flex-direction: column;
                gap: 0.5rem;
            }

            .tab-button {
                width: 100%;
                text-align: center;
            }

            .stats-grid {
                flex-direction: column;
            }
            
            .stats-grid .stat-card {
                flex: 1;
                min-width: 100%;
            }

            .upload-card {
                padding: 2rem 1.5rem;
            }

            .transactions-table {
                font-size: 0.8rem;
            }

            .transactions-table th,
            .transactions-table td {
                padding: 0.75rem 0.5rem;
            }

            .recent-transactions-section .section-header {
                padding: 1.25rem 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0.75rem;
            }

            .dashboard-title {
                font-size: 1.75rem;
            }

            .product-name {
                font-size: 1.5rem;
            }

            .summary-cards-section {
                padding: 1rem;
            }

            .section-content {
                padding: 1rem;
            }

            .upload-card {
                padding: 1.5rem 1rem;
            }

            .upload-icon {
                font-size: 2.5rem;
            }

            .stat-card {
                padding: 1.5rem;
            }

            .stat-number {
                font-size: 1.75rem;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-5 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-5 { margin-bottom: 1.5rem; }
        .hidden { display: none; }
        .block { display: block; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .leading-tight { line-height: 1.25; }
        .leading-normal { line-height: 1.5; }
        .leading-relaxed { line-height: 1.625; }
        .rounded { border-radius: var(--border-radius); }
        .rounded-lg { border-radius: var(--border-radius-lg); }
        .rounded-xl { border-radius: var(--border-radius-xl); }
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        .shadow-xl { box-shadow: var(--shadow-xl); }
        .transition { transition: var(--transition); }
        .cursor-pointer { cursor: pointer; }
        .select-none { user-select: none; }
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }

        /* Recent Transactions Section */
        .recent-transactions-section {
            background: var(--bg-primary);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .recent-transactions-section .section-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
        }

        .recent-transactions-section .section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .recent-transactions-section .section-title i {
            color: var(--success-color);
            font-size: 1.25rem;
        }

        .recent-transactions-section .section-title h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .table-container {
            padding: 0;
            overflow-x: auto;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .transactions-table th {
            background: var(--bg-tertiary);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .transactions-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .transactions-table tr:hover {
            background: var(--bg-secondary);
        }

        .transactions-table .amount {
            font-weight: 600;
            color: var(--text-primary);
        }

        .transactions-table .amount.positive {
            color: var(--success-color);
        }

        .category-badge {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }

        .confidence {
            font-weight: 600;
        }

        .confidence.high {
            color: var(--success-color);
        }

        .confidence.medium {
            color: var(--warning-color);
        }

        .confidence.low {
            color: var(--error-color);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-badge.reconciled {
            background: rgba(5, 150, 105, 0.1);
            color: var(--success-color);
        }

        .status-badge.pending {
            background: rgba(217, 119, 6, 0.1);
            color: var(--warning-color);
        }

        .status-badge.reviewed {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-light);
        }

        .overflow-y-auto { overflow-y: auto; }

        /* Advanced Filters Section */
        .filters-section {
            background: var(--bg-primary);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .filter-input {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: var(--transition);
            background: var(--bg-primary);
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .date-inputs, .amount-inputs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-inputs span, .amount-inputs span {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Charts Section */
        .charts-section {
            background: var(--bg-primary);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        .chart-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border-light);
            text-align: center;
        }

        .chart-card h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .chart-card canvas {
            max-width: 100%;
            height: auto;
        }

        /* Advanced Analytics Section */
        .analytics-section {
            background: var(--bg-primary);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .analytics-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border-light);
        }

        .analytics-card h3 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.125rem;
        }

        /* Performance Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .metric-item {
            text-align: center;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .metric-trend {
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .metric-trend.positive {
            color: var(--success-color);
        }

        .metric-trend.negative {
            color: var(--error-color);
        }

        /* Trend Analysis */
        .trend-analysis {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .trend-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .trend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trend-label {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .trend-value {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .trend-value.positive {
            color: var(--success-color);
        }

        .trend-value.negative {
            color: var(--error-color);
        }

        .trend-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .trend-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Predictive Insights */
        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .insight-item {
            display: flex;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .insight-icon.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .insight-icon.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
        }

        .insight-icon.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .insight-content h4 {
            margin: 0 0 0.25rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .insight-content p {
            margin: 0;
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* System Health */
        .health-metrics {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .health-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .health-label {
            width: 120px;
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .health-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .health-value {
            width: 50px;
            text-align: right;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Notification System */
        .notification-center {
            position: fixed;
            top: 80px;
            right: -400px;
            width: 380px;
            height: 500px;
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow: hidden;
        }

        .notification-center.show {
            right: 20px;
        }

        .notification-header {
            padding: 1rem 1.5rem;
            background: var(--gradient-primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .btn-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .btn-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notification-list {
            height: calc(100% - 60px);
            overflow-y: auto;
            padding: 0;
        }

        .notification-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition);
            animation: slideIn 0.3s ease;
        }

        .notification-item:hover {
            background: var(--bg-secondary);
        }

        .notification-item.success {
            border-left: 4px solid var(--success-color);
        }

        .notification-item.error {
            border-left: 4px solid var(--error-color);
        }

        .notification-item.warning {
            border-left: 4px solid var(--warning-color);
        }

        .notification-item.info {
            border-left: 4px solid var(--primary-color);
        }

        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            flex: 1;
        }

        .notification-icon {
            color: var(--primary-color);
            font-size: 1.25rem;
            margin-top: 0.125rem;
        }

        .notification-text p {
            margin: 0 0 0.25rem 0;
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .notification-text small {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            transition: var(--transition);
            margin-left: 0.5rem;
        }

        .notification-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .notification-toggle {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .notification-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .summary-cards {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .summary-card {
                padding: 1.5rem;
            }

            .card-value {
                font-size: 1.75rem;
            }

            .summary-actions {
                flex-direction: column;
                gap: 0.75rem;
            }

            .summary-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .filters-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .chart-card {
                padding: 1rem;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .analytics-card {
                padding: 1rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .metric-item {
                padding: 0.75rem;
            }

            .metric-value {
                font-size: 1.25rem;
            }

            .health-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .health-label {
                width: auto;
            }

            .health-bar {
                width: 100%;
            }

            .health-value {
                width: auto;
                text-align: left;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .section-content {
                padding: 1rem;
            }

            .section-header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
            }

            .upload-card {
                padding: 1.5rem;
            }

            .upload-icon {
                font-size: 2rem;
            }

            .upload-card h3 {
                font-size: 1.125rem;
            }

            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.875rem;
            }

            .stats-cards {
                flex-direction: column;
                gap: 1rem;
            }

            .stats-card {
                padding: 1rem;
            }

            .notification-center {
                width: calc(100vw - 2rem);
                right: -100vw;
                top: 70px;
                height: calc(100vh - 90px);
            }

            .notification-center.show {
                right: 1rem;
            }

            .notification-toggle {
                top: 80px;
                right: 1rem;
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }

            .dashboard-results-area {
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                max-height: 100vh;
            }

            .dashboard-results-content {
                padding: 1rem;
            }

            .results-header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
            }

            .results-header h2 {
                font-size: 1.25rem;
            }

            .results-tabs {
                flex-direction: column;
                gap: 0.5rem;
            }

            .results-tab {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .results-content {
                padding: 1rem;
                max-height: calc(100vh - 200px);
                overflow-y: auto;
            }

            .table-responsive {
                font-size: 0.75rem;
            }

            .table-responsive th,
            .table-responsive td {
                padding: 0.5rem 0.25rem;
            }

            .badge {
                font-size: 0.625rem;
                padding: 0.25rem 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0.75rem;
            }

            .header {
                padding: 0.75rem;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            .summary-card {
                padding: 1rem;
            }

            .card-value {
                font-size: 1.5rem;
            }

            .section-content {
                padding: 0.75rem;
            }

            .upload-card {
                padding: 1rem;
            }

            .btn {
                padding: 0.625rem 1rem;
                font-size: 0.8rem;
            }
        }

        /* Performance Optimizations */
        .lazy-load {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        .lazy-load.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Dashboard Results Area */
        .dashboard-results-area {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            background: var(--bg-primary);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
            overflow: hidden;
            z-index: 1000;
            display: none;
        }

        .dashboard-results-area.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        /* Backdrop overlay */
        .dashboard-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            backdrop-filter: blur(4px);
        }

        .dashboard-backdrop.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .results-header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .results-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .results-title i {
            color: var(--primary-light);
            font-size: 1.25rem;
        }

        .results-title h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .results-content {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .results-content::-webkit-scrollbar {
            width: 6px;
        }

        .results-content::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        .results-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .results-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        /* Ensure content doesn't overflow horizontally */
        .cashflow-dashboard {
            max-width: 100%;
            overflow-x: hidden;
        }

        .cashflow-dashboard > div {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Recent Transactions Section */

        /* Anomaly Detection Styles */
        .anomaly-results {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .anomaly-item {
            background: var(--bg-secondary);
            border-left: 4px solid var(--warning-color);
            transition: var(--transition);
        }

        .anomaly-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .anomaly-item.text-danger {
            border-left-color: var(--error-color);
            background: rgba(220, 38, 38, 0.05);
        }

        .anomaly-item.text-warning {
            border-left-color: var(--warning-color);
            background: rgba(217, 119, 6, 0.05);
        }

        .anomaly-item.text-info {
            border-left-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
        }

        .text-danger {
            color: var(--error-color) !important;
        }

        .text-warning {
            color: var(--warning-color) !important;
        }

        .text-info {
            color: var(--primary-color) !important;
        }

        /* Prediction Section Styles */
        .predictions-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
        }

        .predictions-section .section-header {
            background: rgba(245, 158, 11, 0.1);
        }

        .btn-info {
            background: var(--primary-color);
            color: white;
        }

        .btn-info:hover {
            background: var(--primary-dark);
        }

        .btn-info:disabled {
            background: var(--text-light);
            cursor: not-allowed;
        }

        /* Clean Anomaly Results Styles */
        .anomaly-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .anomaly-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .anomaly-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .anomaly-filters .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .anomaly-filters .btn.active {
            background: var(--primary-color);
            color: white;
        }

        .anomaly-filters .btn:first-child {
            background: var(--error-color);
            color: white;
        }

        .anomaly-item {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .anomaly-item.text-danger {
            border-left-color: #dc3545;
        }

        .anomaly-item.text-warning {
            border-left-color: #ffc107;
        }

        .anomaly-item.text-info {
            border-left-color: #17a2b8;
        }

        .anomaly-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card {
            transition: all 0.3s ease;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .anomaly-badge {
            min-width: 60px;
            text-align: center;
        }

        .btn-purple-600 {
            background-color: #9333ea;
            color: white;
        }

        .btn-purple-600:hover {
            background-color: #7c3aed;
            color: white;
        }

        .text-purple-600 {
            color: #9333ea;
        }

        .stat-card[onclick] {
            transition: var(--transition);
        }

        .stat-card[onclick]:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .bg-light {
            background: var(--bg-secondary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-logo">
                    <div class="logo-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="logo-text">
                        <h1 class="product-name">Enterprise SAP-Bank Reconciliation Platform</h1>
                        <p class="product-subtitle">Advanced financial reconciliation with AI-powered categorization</p>
                    </div>
                </div>
            </div>
            <div class="header-status">
                <div class="status-indicator"></div>
                <span>System Online</span>
            </div>
        </div>
    </header>

    <!-- Backdrop for dashboard results -->
    <div class="dashboard-backdrop" id="dashboardBackdrop"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Dashboard Title Section -->
        <div class="dashboard-title-section">
            <h1 class="dashboard-title">Reconciliation Dashboard</h1>
            <p class="dashboard-subtitle">Advanced financial reconciliation with AI-powered transaction categorization and real-time insights.</p>
        </div>



        <!-- Advanced Filters Section -->
        <div class="filters-section" id="filtersSection" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-filter"></i>
                    <h2>Advanced Filters</h2>
                </div>
                <button class="btn btn-outline btn-sm" onclick="toggleFilters()">
                    <i class="fas fa-times"></i>
                    Hide Filters
                </button>
            </div>
            <div class="section-content">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>Date Range</label>
                        <div class="date-inputs">
                            <input type="date" id="startDate" class="filter-input">
                            <span>to</span>
                            <input type="date" id="endDate" class="filter-input">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Amount Range</label>
                        <div class="amount-inputs">
                            <input type="number" id="minAmount" placeholder="Min Amount" class="filter-input">
                            <span>to</span>
                            <input type="number" id="maxAmount" placeholder="Max Amount" class="filter-input">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Category</label>
                        <select id="categoryFilter" class="filter-input">
                            <option value="">All Categories</option>
                            <option value="Operating Activities">Operating Activities</option>
                            <option value="Investing Activities">Investing Activities</option>
                            <option value="Financing Activities">Financing Activities</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" id="searchFilter" placeholder="Search transactions..." class="filter-input">
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-search"></i>
                        Apply Filters
                    </button>
                    <button class="btn btn-outline" onclick="clearFilters()">
                        <i class="fas fa-undo"></i>
                        Clear All
                    </button>
                </div>
            </div>
        </div>

        <!-- Charts Dashboard Section -->
        <div class="charts-section" id="chartsSection" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-pie"></i>
                    <h2>Analytics Dashboard</h2>
                </div>
                <button class="btn btn-outline btn-sm" onclick="toggleCharts()">
                    <i class="fas fa-times"></i>
                    Hide Charts
                </button>
            </div>
            <div class="section-content">
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Category Distribution</h3>
                        <canvas id="categoryChart" width="400" height="300"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Monthly Trends</h3>
                        <canvas id="trendsChart" width="400" height="300"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Reconciliation Status</h3>
                        <canvas id="statusChart" width="400" height="300"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Cash Flow Analysis</h3>
                        <canvas id="cashFlowChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Analytics Section -->
        <div class="analytics-section" id="analyticsSection" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    <h2>Advanced Analytics</h2>
                </div>
                <button class="btn btn-outline btn-sm" onclick="toggleAnalytics()">
                    <i class="fas fa-times"></i>
                    Hide Analytics
                </button>
            </div>
            <div class="section-content">
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>Performance Metrics</h3>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Reconciliation Rate</div>
                                <div class="metric-value">94.2%</div>
                                <div class="metric-trend positive">
                                    <i class="fas fa-arrow-up"></i>
                                    +2.1%
                                </div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Processing Time</div>
                                <div class="metric-value">1.8s</div>
                                <div class="metric-trend negative">
                                    <i class="fas fa-arrow-down"></i>
                                    -0.3s
                                </div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Accuracy Rate</div>
                                <div class="metric-value">98.7%</div>
                                <div class="metric-trend positive">
                                    <i class="fas fa-arrow-up"></i>
                                    +0.5%
                                </div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Error Rate</div>
                                <div class="metric-value">1.3%</div>
                                <div class="metric-trend negative">
                                    <i class="fas fa-arrow-down"></i>
                                    -0.2%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h3>Trend Analysis</h3>
                        <div class="trend-analysis">
                            <div class="trend-item">
                                <div class="trend-header">
                                    <span class="trend-label">Monthly Growth</span>
                                    <span class="trend-value positive">+12.5%</span>
                                </div>
                                <div class="trend-bar">
                                    <div class="trend-fill" style="width: 75%"></div>
                                </div>
                            </div>
                            <div class="trend-item">
                                <div class="trend-header">
                                    <span class="trend-label">Efficiency Score</span>
                                    <span class="trend-value positive">+8.3%</span>
                                </div>
                                <div class="trend-bar">
                                    <div class="trend-fill" style="width: 83%"></div>
                                </div>
                            </div>
                            <div class="trend-item">
                                <div class="trend-header">
                                    <span class="trend-label">Cost Savings</span>
                                    <span class="trend-value positive">+15.2%</span>
                                </div>
                                <div class="trend-bar">
                                    <div class="trend-fill" style="width: 92%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h3>Predictive Insights</h3>
                        <div class="insights-list">
                            <div class="insight-item">
                                <div class="insight-icon warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="insight-content">
                                    <h4>Potential Discrepancy Alert</h4>
                                    <p>Based on historical patterns, 3 transactions may require manual review within 24 hours.</p>
                                </div>
                            </div>
                            <div class="insight-item">
                                <div class="insight-icon info">
                                    <i class="fas fa-lightbulb"></i>
                                </div>
                                <div class="insight-content">
                                    <h4>Optimization Opportunity</h4>
                                    <p>Automated matching rate could improve by 5% with additional keyword training.</p>
                                </div>
                            </div>
                            <div class="insight-item">
                                <div class="insight-icon success">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="insight-content">
                                    <h4>Performance Forecast</h4>
                                    <p>Expected to process 15% more transactions next month based on current trends.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h3>System Health</h3>
                        <div class="health-metrics">
                            <div class="health-item">
                                <div class="health-label">CPU Usage</div>
                                <div class="health-bar">
                                    <div class="health-fill" style="width: 45%"></div>
                                </div>
                                <div class="health-value">45%</div>
                            </div>
                            <div class="health-item">
                                <div class="health-label">Memory Usage</div>
                                <div class="health-bar">
                                    <div class="health-fill" style="width: 62%"></div>
                                </div>
                                <div class="health-value">62%</div>
                            </div>
                            <div class="health-item">
                                <div class="health-label">Database Performance</div>
                                <div class="health-bar">
                                    <div class="health-fill" style="width: 78%"></div>
                                </div>
                                <div class="health-value">78%</div>
                            </div>
                            <div class="health-item">
                                <div class="health-label">Network Latency</div>
                                <div class="health-bar">
                                    <div class="health-fill" style="width: 23%"></div>
                                </div>
                                <div class="health-value">23ms</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Step 1: File Upload -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-number">1</div>
                <div class="section-title">
                    <h2>Data Import & Validation</h2>
                    <p>Upload financial data files for processing and reconciliation</p>
                </div>
            </div>
            <div class="section-content">
                <div class="grid">
                    <!-- Bank Statement Upload -->
                    <div class="upload-card" id="bankUploadArea">
                        <input type="file" id="bankFile" class="hidden" accept=".xlsx,.xls,.csv">
                        <i class="fas fa-university upload-icon"></i>
                        <h3>Bank Statement Data</h3>
                        <p>Upload bank statement file with transaction details (Required)</p>
                        <button class="btn btn-primary" onclick="document.getElementById('bankFile').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Choose Bank File
                        </button>
                        <div id="bankFileInfo" class="file-info">
                            <h4><i class="fas fa-check-circle"></i> File Selected:</h4>
                            <p id="bankFileName"></p>
                        </div>
                    </div>

                    <!-- SAP Data Upload -->
                    <div class="upload-card" id="sapUploadArea">
                        <input type="file" id="sapFile" class="hidden" accept=".xlsx,.xls,.csv">
                        <i class="fas fa-database upload-icon"></i>
                        <h3>SAP Transaction Data</h3>
                        <p>Upload SAP file for full reconciliation (Optional)</p>
                        <button class="btn btn-outline" onclick="document.getElementById('sapFile').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Choose SAP File
                        </button>
                        <div id="sapFileInfo" class="file-info">
                            <h4><i class="fas fa-check-circle"></i> File Selected:</h4>
                            <p id="sapFileName"></p>
                        </div>
                    </div>
                </div>

                                <div class="text-center mt-4">
                    <button class="btn btn-primary" id="uploadBtn" onclick="uploadFiles()" disabled>
                        <i class="fas fa-upload"></i>
                        Upload & Process Files
                    </button>
                </div>

                <div class="progress-container" id="uploadProgress">
                    <div class="progress">
                        <div class="progress-bar" id="uploadProgressBar"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Reconciliation Process -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-number">2</div>
                <div class="section-title">
                    <h2>Reconciliation Engine</h2>
                    <p>AI-powered matching algorithms and categorization</p>
                </div>
            </div>
            <div class="section-content">
                <div class="btn-group text-center">
                    <button class="btn btn-secondary" id="reconcileBtn" onclick="reconcileData()" disabled>
                        <i class="fas fa-cogs"></i>
                        Start Reconciliation
                    </button>
                    <button class="btn btn-outline" onclick="checkStatus()">
                        <i class="fas fa-info-circle"></i>
                        System Status
                    </button>
                </div>

                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>Processing reconciliation with AI categorization...</p>
                </div>

                <!-- Summary Dashboard -->
                <div id="summaryDashboard" class="hidden">
                    <h3 class="mb-3">
                        <i class="fas fa-chart-pie"></i>
                        Reconciliation Summary
                    </h3>
                    <div class="stats-grid-horizontal" id="summaryStats"></div>
                    <div id="validationStatus"></div>
                </div>
            </div>
        </div>

        <!-- Step 3: Analysis & Results -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-number">3</div>
                <div class="section-title">
                    <h2>Analytics & Reports</h2>
                    <p>Comprehensive analysis with category breakdown and insights</p>
                </div>
            </div>
            <div class="section-content">
                <div class="grid grid-sm">
                    <!-- Exact Matches -->
                    <div class="stat-card">
                        <i class="fas fa-check-double stat-icon"></i>
                        <h3 class="font-semibold mb-2">High Confidence Matches</h3>
                        <p class="text-sm text-secondary mb-3">Exact matches with 85%+ confidence</p>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="viewCategoryData('matched_exact')">
                                <i class="fas fa-eye"></i>
                                View Analysis
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadFile('matched_exact')">
                                <i class="fas fa-download"></i>
                                Export
                            </button>

                        </div>
                    </div>

                    <!-- Fuzzy Matches -->
                    <div class="stat-card">
                        <i class="fas fa-search stat-icon"></i>
                        <h3 class="font-semibold mb-2">Partial Matches</h3>
                        <p class="text-sm text-secondary mb-3">Fuzzy matches with 60-85% confidence</p>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="viewCategoryData('matched_fuzzy')">
                                <i class="fas fa-eye"></i>
                                View Analysis
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadFile('matched_fuzzy')">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>

                    <!-- Unmatched SAP -->
                    <div class="stat-card">
                        <i class="fas fa-database stat-icon"></i>
                        <h3 class="font-semibold mb-2">Unmatched SAP Transactions</h3>
                        <p class="text-sm text-secondary mb-3">SAP entries without bank matches</p>
                        <div class="btn-group">
                            <button class="btn btn-warning btn-sm" onclick="viewCategoryData('unmatched_sap')">
                                <i class="fas fa-eye"></i>
                                View by Category
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadFile('unmatched_sap')">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>

                    <!-- Unmatched Bank -->
                    <div class="stat-card">
                        <i class="fas fa-university stat-icon"></i>
                        <h3 class="font-semibold mb-2">Unmatched Bank Transactions</h3>
                        <p class="text-sm text-secondary mb-3">Bank entries without SAP matches</p>
                        <div class="btn-group">
                            <button class="btn btn-warning btn-sm" onclick="viewCategoryData('unmatched_bank')">
                                <i class="fas fa-eye"></i>
                                View by Category
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadFile('unmatched_bank')">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>

                    <!-- Cash Flow Analysis -->
                    <div class="stat-card">
                        <i class="fas fa-chart-line stat-icon"></i>
                        <h3 class="font-semibold mb-2">Cash Flow Statement</h3>
                        <p class="text-sm text-secondary mb-3">Complete cash flow with categorization</p>
                        <div class="btn-group">
                            <button class="btn btn-secondary btn-sm" onclick="viewCategoryData('cash_flow')">
                                <i class="fas fa-eye"></i>
                                View Analysis
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadFile('cash_flow')">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: AP/AR Management -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-number">4</div>
                <div class="section-title">
                    <h2>AP/AR Management</h2>
                    <p>Comprehensive accounts payable and receivable analysis</p>
                </div>
            </div>
            <div class="section-content">
                <!-- AP/AR Dashboard Summary -->
                <div id="apArDashboard" class="hidden">
                    <h3 class="mb-3">
                        <i class="fas fa-tachometer-alt"></i>
                        AP/AR Dashboard Overview
                    </h3>
                    <div class="stats-grid-horizontal" id="apArSummaryStats"></div>
                    <div id="apArValidation"></div>
                </div>

                <div class="grid">
                    <!-- AP/AR Dashboard -->
                    <div class="stat-card">
                        <i class="fas fa-tachometer-alt stat-icon"></i>
                        <h3 class="font-semibold mb-2">AP/AR Dashboard</h3>
                        <p class="text-sm text-secondary mb-3">Complete overview with key metrics</p>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="loadAPARDashboard()">
                                <i class="fas fa-chart-pie"></i>
                                View Dashboard
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadAPAR('combined_dashboard')">
                                <i class="fas fa-download"></i>
                                Export Report
                            </button>
                        </div>
                    </div>

                    <!-- Accounts Payable -->
                    <div class="stat-card">
                        <i class="fas fa-credit-card stat-icon"></i>
                        <h3 class="font-semibold mb-2">Accounts Payable</h3>
                        <p class="text-sm text-secondary mb-3">Vendor payments and aging analysis</p>
                        <div class="btn-group">
                            <button class="btn btn-danger btn-sm" onclick="loadAPAnalysis()">
                                <i class="fas fa-eye"></i>
                                View AP Analysis
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadAPAR('ap_analysis')">
                                <i class="fas fa-download"></i>
                                Export AP
                            </button>
                        </div>
                    </div>

                    <!-- Accounts Receivable -->
                    <div class="stat-card">
                        <i class="fas fa-money-check-alt stat-icon"></i>
                        <h3 class="font-semibold mb-2">Accounts Receivable</h3>
                        <p class="text-sm text-secondary mb-3">Customer payments and collection analysis</p>
                        <div class="btn-group">
                            <button class="btn btn-secondary btn-sm" onclick="loadARAnalysis()">
                                <i class="fas fa-eye"></i>
                                View AR Analysis
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadAPAR('ar_analysis')">
                                <i class="fas fa-download"></i>
                                Export AR
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: AI Predictions & Anomaly Detection -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-number">5</div>
                <div class="section-title">
                    <h2>AI Predictions & Anomaly Detection</h2>
                    <p>Advanced predictive analytics and fraud detection</p>
                </div>
            </div>
            <div class="section-content">


                <div class="grid">
                    <!-- Anomaly Detection -->
                    <div class="stat-card">
                        <i class="fas fa-robot stat-icon text-purple-600"></i>
                        <h3 class="font-semibold mb-2">AI-Powered Anomaly Detection</h3>
                        <p class="text-sm text-secondary mb-3">Advanced ML algorithms detect fraud & unusual patterns</p>
                        <div class="ai-status mb-2">
                            <span class="badge bg-success text-white text-xs">
                                <i class="fas fa-check-circle"></i> AI/ML Ready
                            </span>
                            <span class="text-xs text-gray-600 ml-2">4 Models Active</span>
                            <button class="btn btn-outline btn-xs ml-2" onclick="checkAIMLStatus()">
                                <i class="fas fa-sync-alt"></i> Check Status
                            </button>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-purple-600 btn-sm" id="anomalyDetectionBtn" onclick="runAnomalyDetection()" disabled>
                                <i class="fas fa-brain"></i>
                                AI Detect Anomalies
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadAnomalyReport()">
                                <i class="fas fa-download"></i>
                                Export Report
                            </button>
                        </div>
                    </div>

                    <!-- Duplicate Payment Detection -->
                    <div class="stat-card">
                        <i class="fas fa-copy stat-icon text-danger"></i>
                        <h3 class="font-semibold mb-2">Duplicate Detection</h3>
                        <p class="text-sm text-secondary mb-3">Find duplicate or similar payments</p>
                        <div class="btn-group">
                            <button class="btn btn-danger btn-sm" id="duplicateDetectionBtn" onclick="runDuplicateDetection()" disabled>
                                <i class="fas fa-search"></i>
                                Find Duplicates
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadPredictions('duplicate_detection')">
                                <i class="fas fa-download"></i>
                                Export Report
                            </button>
                        </div>
                    </div>

                    <!-- Cash Flow Forecasting -->
                    <div class="stat-card">
                        <i class="fas fa-chart-line stat-icon text-primary"></i>
                        <h3 class="font-semibold mb-2">Cash Flow Forecasting</h3>
                        <p class="text-sm text-secondary mb-3">Predict future cash flows</p>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" id="cashflowForecastBtn" onclick="runCashflowForecast()">
                                <i class="fas fa-crystal-ball"></i>
                                Forecast Cash Flow
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadPredictions('cashflow_forecast')">
                                <i class="fas fa-download"></i>
                                Export Report
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="debugForecast()">
                                <i class="fas fa-bug"></i>
                                Debug
                            </button>
                        </div>
                    </div>

                    <!-- Payment Delay Prediction -->
                    <div class="stat-card">
                        <i class="fas fa-clock stat-icon text-info"></i>
                        <h3 class="font-semibold mb-2">Payment Delay Prediction</h3>
                        <p class="text-sm text-secondary mb-3">Predict payment delays</p>
                        <div class="btn-group">
                            <button class="btn btn-info btn-sm" id="paymentDelayBtn" onclick="runPaymentDelayPrediction()" disabled>
                                <i class="fas fa-hourglass-half"></i>
                                Predict Delays
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadPredictions('payment_delay')">
                                <i class="fas fa-download"></i>
                                Export Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 6: Invoice-Payment Matching -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-number">5</div>
                <div class="section-title">
                    <h2>Invoice-Payment Tracking</h2>
                    <p>Automated invoice matching and payment analysis</p>
                </div>
            </div>
            <div class="section-content">
                <!-- Invoice-Payment Dashboard -->
                <div id="invoicePaymentDashboard" class="hidden">
                    <h3 class="mb-3">
                        <i class="fas fa-link"></i>
                        Invoice-Payment Matching Summary
                    </h3>
                    <div class="stats-grid-horizontal" id="invoicePaymentSummaryStats"></div>
                    <div id="invoicePaymentValidation"></div>
                </div>

                <div class="grid">
                    <!-- Run Matching -->
                    <div class="stat-card">
                        <i class="fas fa-sync-alt stat-icon"></i>
                        <h3 class="font-semibold mb-2">Invoice-Payment Matching</h3>
                        <p class="text-sm text-secondary mb-3">AI-powered automated matching</p>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="runInvoicePaymentMatching()">
                                <i class="fas fa-play"></i>
                                Start Matching
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="debugInvoiceMatching()">
                                <i class="fas fa-bug"></i>
                                Debug Analysis
                            </button>
                        </div>
                    </div>

                    <!-- Matched Pairs -->
                    <div class="stat-card">
                        <i class="fas fa-link stat-icon"></i>
                        <h3 class="font-semibold mb-2">Matched Invoice-Payment Pairs</h3>
                        <p class="text-sm text-secondary mb-3">Successfully linked transactions</p>
                        <div class="btn-group">
                            <button class="btn btn-secondary btn-sm" onclick="viewInvoicePayments('matched_pairs')">
                                <i class="fas fa-eye"></i>
                                View Matches
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadInvoicePayments('matched_pairs')">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>

                    <!-- Outstanding Invoices -->
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle stat-icon"></i>
                        <h3 class="font-semibold mb-2">Outstanding Invoices</h3>
                        <p class="text-sm text-secondary mb-3">Invoices awaiting payment</p>
                        <div class="btn-group">
                            <button class="btn btn-warning btn-sm" onclick="viewInvoicePayments('unmatched_invoices')">
                                <i class="fas fa-eye"></i>
                                View Outstanding
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadInvoicePayments('unmatched_invoices')">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>

                    <!-- Orphaned Payments -->
                    <div class="stat-card">
                        <i class="fas fa-question-circle stat-icon"></i>
                        <h3 class="font-semibold mb-2">Orphaned Payments</h3>
                        <p class="text-sm text-secondary mb-3">Payments without matching invoices</p>
                        <div class="btn-group">
                            <button class="btn btn-warning btn-sm" onclick="viewInvoicePayments('unmatched_payments')">
                                <i class="fas fa-eye"></i>
                                View Orphaned
                            </button>
                            <button class="btn btn-success btn-sm" onclick="downloadOrphanedPaymentsEnhanced()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>

                    <!-- Payment Efficiency -->
                    <div class="stat-card">
                        <i class="fas fa-chart-line stat-icon"></i>
                        <h3 class="font-semibold mb-2">Payment Efficiency</h3>
                        <p class="text-sm text-secondary mb-3">Timing analysis and KPIs</p>
                        <div class="btn-group">
                            <button class="btn btn-secondary btn-sm" onclick="viewInvoicePayments('efficiency_dashboard')">
                                <i class="fas fa-tachometer-alt"></i>
                                View Dashboard
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadInvoicePayments('complete_analysis')">
                                <i class="fas fa-download"></i>
                                Full Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Step 6: Vendor Cash Flow Analysis -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-number">6</div>
                <div class="section-title">
                    <h2>Vendor Cash Flow Analysis</h2>
                    <p>AI-powered vendor-wise cash flow breakdown and analysis</p>
                </div>
            </div>
            <div class="section-content">
                <!-- Vendor Cash Flow Dashboard -->
                <div id="vendorCashFlowDashboard" class="hidden">
                    <h3 class="mb-3">
                        <i class="fas fa-industry"></i>
                        Vendor Cash Flow Summary
                    </h3>
                    <div class="stats-grid-horizontal" id="vendorCashFlowSummaryStats"></div>
                    <div id="vendorCashFlowValidation"></div>
                </div>

                <div class="grid">
                    <!-- Run Vendor Analysis -->
                    <div class="stat-card">
                        <i class="fas fa-play-circle stat-icon"></i>
                        <h3 class="font-semibold mb-2">Run Vendor Analysis</h3>
                        <p class="text-sm text-secondary mb-3">AI-powered vendor cash flow analysis</p>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="runVendorAnalysis()">
                                <i class="fas fa-play"></i>
                                Start Analysis
                            </button>
                        </div>
                    </div>

                    <!-- All Vendors Cash Flow -->
                    <div class="stat-card">
                        <i class="fas fa-chart-line stat-icon"></i>
                        <h3 class="font-semibold mb-2">All Vendors Cash Flow</h3>
                        <p class="text-sm text-secondary mb-3">Combined vendor cash flow analysis</p>
                        <div class="btn-group">
                            <button class="btn btn-secondary btn-sm" onclick="viewCategoryData('vendor_cashflow_all')" id="viewAllVendorsBtn" disabled>
                                <i class="fas fa-eye"></i>
                                View Analysis
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="downloadFile('vendor_cashflow_all')" id="downloadAllVendorsBtn" disabled>
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>

                    <!-- Individual Vendor Selection -->
                    <div class="stat-card">
                        <i class="fas fa-user-tie stat-icon"></i>
                        <h3 class="font-semibold mb-2">Individual Vendor Analysis</h3>
                        <p class="text-sm text-secondary mb-3">Select specific vendor for detailed analysis</p>
                        <div class="btn-group">
                            <select id="vendorSelect" onchange="viewIndividualVendor()" class="btn btn-outline btn-sm" style="width: 100%; margin-bottom: 10px;" disabled>
                                <option value="">Choose a vendor...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Results will now be displayed in the dashboard area above -->
        <!-- System Messages -->
        <div id="messageContainer">
            <!-- Alert messages will be dynamically inserted here -->
        </div>

        <!-- Dashboard Results Area -->
        <div class="dashboard-results-area" id="dashboardResultsArea">
            <div class="results-header" id="resultsHeader" style="display: none;">
                <div class="results-title">
                    <i class="fas fa-chart-bar"></i>
                    <h2 id="resultsTitle">Analysis Results</h2>
                </div>
                <button class="btn btn-outline btn-sm" onclick="closeResults()">
                    <i class="fas fa-times"></i>
                    Close
                </button>
            </div>
            <div class="results-content" id="resultsContent">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>

        <!-- Complete Bottom Dashboard Section -->
        <div class="bottom-dashboard-section" style="margin-top: 3rem;">
            <!-- Summary Cards Section -->
            <div class="summary-cards-section bottom-dashboard">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-chart-bar"></i>
                        <h2>Dashboard Overview</h2>
                    </div>
                </div>
                <div class="section-content">
                    <div class="summary-cards-grid">
                        <div class="summary-card">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div class="card-trend positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="transactionsTrend">--</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="card-value" id="totalTransactions">--</div>
                                <div class="card-label">Total Transactions</div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="card-trend positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="reconciledTrend">--</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="card-value" id="reconciledAmount">--</div>
                                <div class="card-label">Reconciled Amount</div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="card-trend negative">
                                    <i class="fas fa-arrow-down"></i>
                                    <span id="pendingTrend">--</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="card-value" id="pendingReviews">--</div>
                                <div class="card-label">Pending Reviews</div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="card-trend positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="usersTrend">--</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="card-value" id="activeUsers">--</div>
                                <div class="card-label">Active Users</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions Section -->
            <div class="section-card" style="margin-top: 2rem;">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-check-circle"></i>
                        <h2>Recent Transactions with AI Categorization</h2>
                    </div>
                </div>
                <div class="section-content">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>AI Category</th>
                                    <th>Confidence</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align:center; color: var(--text-secondary);">
                                        <i class="fas fa-info-circle"></i> No recent transactions to display. Upload files to see transaction data.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons (All together at the bottom) -->
            <div class="summary-actions" style="margin-top: 2rem;">
                <button class="btn btn-outline" onclick="toggleFilters()">
                    <i class="fas fa-filter"></i>
                    Advanced Filters
                </button>
                <button class="btn btn-outline" onclick="toggleCharts()">
                    <i class="fas fa-chart-pie"></i>
                    Analytics Dashboard
                </button>
                <button class="btn btn-outline" onclick="toggleAnalytics()">
                    <i class="fas fa-analytics"></i>
                    Advanced Analytics
                </button>
                <button class="btn btn-outline" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    Export Data
                </button>
                <button class="btn btn-outline" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let sapFileUploaded = false;
        let bankFileUploaded = false;
        let filesProcessed = false;



        function initializeEventListeners() {
            // File input change listeners
            document.getElementById('sapFile').addEventListener('change', function(e) {
                handleFileSelect(e, 'sap');
            });

            document.getElementById('bankFile').addEventListener('change', function(e) {
                handleFileSelect(e, 'bank');
            });

            // Drag and drop functionality
            setupDragAndDrop();
            
            // Click outside to close dashboard results
            document.getElementById('dashboardBackdrop').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeResults();
                }
            });
        }

        function setupDragAndDrop() {
            ['sapUploadArea', 'bankUploadArea'].forEach(id => {
                const area = document.getElementById(id);
                
                area.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    area.classList.add('dragover');
                });

                area.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    area.classList.remove('dragover');
                });

                area.addEventListener('drop', function(e) {
                    e.preventDefault();
                    area.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileType = id.includes('sap') ? 'sap' : 'bank';
                        const fileInput = document.getElementById(fileType + 'File');
                        fileInput.files = files;
                        handleFileSelect({target: fileInput}, fileType);
                    }
                });
            });
        }

        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            console.log('handleFileSelect called with type:', type, 'file:', file ? file.name : 'none');
            
            if (!file) {
                // File was deselected
                if (type === 'sap') {
                    sapFileUploaded = false;
                    document.getElementById('sapFileInfo').classList.remove('show');
                } else {
                    bankFileUploaded = false;
                    document.getElementById('bankFileInfo').classList.remove('show');
                }
                updateUploadButton();
                return;
            }

            const allowedTypes = ['.xlsx', '.xls', '.csv'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExt)) {
                showAlert('Please select a valid Excel (.xlsx, .xls) or CSV file', 'error');
                return;
            }

            // Update upload status and show file info
            if (type === 'sap') {
                sapFileUploaded = true;
                document.getElementById('sapFileName').textContent = `${file.name} (${formatFileSize(file.size)})`;
                document.getElementById('sapFileInfo').classList.add('show');
            } else {
                bankFileUploaded = true;
                document.getElementById('bankFileName').textContent = `${file.name} (${formatFileSize(file.size)})`;
                document.getElementById('bankFileInfo').classList.add('show');
                console.log('Bank file selected:', file.name, 'bankFileUploaded set to:', bankFileUploaded);
            }
            updateUploadButton();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateUploadButton() {
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = !bankFileUploaded; // Only bank file is required
            console.log('Upload button state:', { bankFileUploaded, disabled: uploadBtn.disabled });
        }
        

        


        function enablePredictionButtons() {
            // Enable all prediction buttons after reconciliation is completed
            const anomalyBtn = document.getElementById('anomalyDetectionBtn');
            const duplicateBtn = document.getElementById('duplicateDetectionBtn');
            const cashflowBtn = document.getElementById('cashflowForecastBtn');
            const paymentDelayBtn = document.getElementById('paymentDelayBtn');
            
            if (anomalyBtn) anomalyBtn.disabled = false;
            if (duplicateBtn) duplicateBtn.disabled = false;
            if (cashflowBtn) cashflowBtn.disabled = false;
            if (paymentDelayBtn) paymentDelayBtn.disabled = false;
            
            showAlert('AI Predictions are now available!', 'success');
        }
        
        async function uploadFiles() {
            const sapFile = document.getElementById('sapFile').files[0];
            const bankFile = document.getElementById('bankFile').files[0];
            
            if (!bankFile) {
                showAlert('Please select a Bank file', 'error');
                return;
            }

            const formData = new FormData();
            if (sapFile) {
                formData.append('sap_file', sapFile);
            }
            formData.append('bank_file', bankFile);

            try {
                showProgress('upload', true);
                updateProgressBar('upload', 30);

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                updateProgressBar('upload', 70);
                const data = await response.json();
                updateProgressBar('upload', 100);

                if (response.ok) {
                    const mode = data.mode || 'unknown';
                    const modeText = mode === 'full_reconciliation' ? 'Full SAP-Bank Reconciliation' : 'Bank-Only Analysis';
                    
                    showAlert(`Files uploaded successfully! Mode: ${modeText}. SAP Transactions: ${data.sap_transactions}, Bank Transactions: ${data.bank_transactions}`, 'success');
                    
                    filesProcessed = false;
                    document.getElementById('reconcileBtn').disabled = false;
                } else {
                    showAlert(`Upload Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Upload Error: ${error.message}`, 'error');
            } finally {
                showProgress('upload', false);
            }
        }

        async function reconcileData() {
            try {
                showLoading(true);
                
                const response = await fetch('/reconcile', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Reconciliation completed successfully with AI categorization!', 'success');
                    filesProcessed = true;
                    displaySummaryDashboard(data.summary);
                    updateSummaryCards(data.summary);
                    enablePredictionButtons(); // Enable prediction buttons after reconciliation
                } else {
                    showAlert(`Reconciliation Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Reconciliation Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function runAnomalyDetection() {
            try {
                showLoading(true);
                showAlert('Running anomaly detection on your transaction data...', 'info');
                
                const response = await fetch('/anomaly-detection', {
                    method: 'GET'
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    // Display anomaly results in predictions dashboard
                    displayPredictionsResults('anomaly_detection', data);
                    showAlert(`Anomaly detection completed! Found ${data.total_anomalies} anomalies.`, 'success');
                } else {
                    showAlert(`Anomaly Detection Error: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showAlert(`Anomaly Detection Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Placeholder functions for other predictions (will be implemented in Phase 1)
        async function runDuplicateDetection() {
            showAlert('Duplicate Detection - Coming in Phase 1!', 'info');
        }

        async function runCashflowForecast() {
            try {
                showAlert(' Generating enhanced cash flow forecast...', 'info');
                
                const response = await fetch('/cash-flow-forecast?use_ml=true');
                const data = await response.json();
                
                console.log('Cash flow forecast response:', data);
                
                if (data.status === 'success') {
                    if (data.forecast) {
                        // Test if elements exist
                        const resultsArea = document.getElementById('dashboardResultsArea');
                        const resultsContent = document.getElementById('resultsContent');
                        const resultsHeader = document.getElementById('resultsHeader');
                        const resultsTitle = document.getElementById('resultsTitle');
                        
                        console.log('Elements found:', {
                            resultsArea: !!resultsArea,
                            resultsContent: !!resultsContent,
                            resultsHeader: !!resultsHeader,
                            resultsTitle: !!resultsTitle
                        });
                        
                        if (resultsArea && resultsContent && resultsHeader && resultsTitle) {
                            console.log('All elements found, displaying results...');
                            displayCashFlowResults(data.forecast);
                            showAlert(' Enhanced cash flow forecast generated successfully!', 'success');
                        } else {
                            console.error('Required elements not found:', {
                                resultsArea: !!resultsArea,
                                resultsContent: !!resultsContent,
                                resultsHeader: !!resultsHeader,
                                resultsTitle: !!resultsTitle
                            });
                            // Fallback: Display in a simple alert or create a temporary display
                            const forecastSummary = data.forecast.summary;
                            const summaryText = `
7 Days: ${((forecastSummary.total_7_days || 0) / 10000000).toFixed(2)} Cr
4 Weeks: ${((forecastSummary.total_4_weeks || 0) / 10000000).toFixed(2)} Cr
3 Months: ${((forecastSummary.total_3_months || 0) / 10000000).toFixed(2)} Cr
Risk Level: ${forecastSummary.overall_risk || 'MEDIUM'}
                            `.trim();
                            
                            showAlert(` Forecast Generated!\n\n${summaryText}`, 'success');
                        }
                    } else {
                        console.error('No forecast data in response:', data);
                        showAlert(' No forecast data received from server', 'error');
                    }
                } else {
                    showAlert(` Forecast failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Cash flow forecast error:', error);
                showAlert(' Cash flow forecast failed. Please try again.', 'error');
            }
        }

        function debugForecast() {
            console.log('=== DEBUG FORECAST START ===');
            
            // Enable the button for testing
            const cashflowBtn = document.getElementById('cashflowForecastBtn');
            if (cashflowBtn) {
                cashflowBtn.disabled = false;
                console.log('Enabled cash flow forecast button');
            }
            
            // Test API call directly
            fetch('/cash-flow-forecast?use_ml=true')
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    return response.json();
                })
                .then(data => {
                    console.log('Full API response:', data);
                    console.log('Status:', data.status);
                    console.log('Has forecast:', !!data.forecast);
                    if (data.forecast) {
                        console.log('Forecast keys:', Object.keys(data.forecast));
                        console.log('Summary keys:', Object.keys(data.forecast.summary || {}));
                    }
                    
                    // Test element existence
                    const resultsArea = document.getElementById('dashboardResultsArea');
                    const resultsContent = document.getElementById('resultsContent');
                    const resultsHeader = document.getElementById('resultsHeader');
                    const resultsTitle = document.getElementById('resultsTitle');
                    const backdrop = document.getElementById('dashboardBackdrop');
                    
                    console.log('Elements found:', {
                        resultsArea: !!resultsArea,
                        resultsContent: !!resultsContent,
                        resultsHeader: !!resultsHeader,
                        resultsTitle: !!resultsTitle,
                        backdrop: !!backdrop
                    });
                    
                    if (data.status === 'success' && data.forecast) {
                        showAlert(' Debug: API working, data received successfully!', 'success');
                        // Try to display the results
                        displayCashFlowResults(data.forecast);
                    } else {
                        showAlert(` Debug: API issue - ${data.message || 'Unknown error'}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Debug error:', error);
                    showAlert(` Debug: Network error - ${error.message}`, 'error');
                });
        }

        function displayCashFlowResults(forecast) {
            console.log('Displaying cash flow results:', forecast);
            
            const resultsArea = document.getElementById('dashboardResultsArea');
            const resultsContent = document.getElementById('resultsContent');
            const resultsHeader = document.getElementById('resultsHeader');
            const resultsTitle = document.getElementById('resultsTitle');
            const backdrop = document.getElementById('dashboardBackdrop');
            
            // Validate forecast data
            if (!forecast || !forecast.summary) {
                console.error('Invalid forecast data:', forecast);
                showAlert(' Invalid forecast data received', 'error');
                return;
            }
            
            // Show backdrop and results area
            if (backdrop) backdrop.classList.add('show');
            resultsArea.classList.add('show');
            resultsHeader.style.display = 'flex';
            resultsTitle.innerHTML = '<i class="fas fa-chart-line text-primary"></i> Cash Flow Forecast Dashboard';
            
                        // Format amounts for display
            const formatAmount = (amount) => {
                if (!amount || amount === 0) return '0.00';
                const crore = amount / 10000000;
                if (crore >= 1) {
                    return `${crore.toFixed(2)} Cr`;
                } else {
                    return `${(amount / 100000).toFixed(2)} L`;
                }
            };
            
            let html = `
                <div class="cashflow-dashboard" style="font-family: Arial, sans-serif; max-width: 100%; overflow-x: hidden;">
                    <!-- Main Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div onclick="showSummaryDetails('7 Days', ${forecast.summary.total_7_days || 0}, '${forecast.summary.overall_risk || 'MEDIUM'}')" 
                             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;"
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 35px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)'">
                            <div style="font-size: 24px; margin-bottom: 10px;"></div>
                            <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${formatAmount(forecast.summary.total_7_days || 0)}</div>
                            <div style="font-size: 16px; opacity: 0.9;">Next 7 Days</div>
                            <div style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; margin-top: 10px; font-size: 12px;">
                                ${forecast.summary.overall_risk || 'MEDIUM'} Risk
                            </div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 8px;"> Click for details</div>
                        </div>
                        
                        <div onclick="showSummaryDetails('4 Weeks', ${forecast.summary.total_4_weeks || 0}, '${forecast.summary.overall_risk || 'MEDIUM'}')" 
                             style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;"
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 35px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)'">
                            <div style="font-size: 24px; margin-bottom: 10px;"></div>
                            <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${formatAmount(forecast.summary.total_4_weeks || 0)}</div>
                            <div style="font-size: 16px; opacity: 0.9;">Next 4 Weeks</div>
                            <div style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; margin-top: 10px; font-size: 12px;">
                                ${forecast.summary.overall_risk || 'MEDIUM'} Risk
                            </div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 8px;"> Click for details</div>
                        </div>
                        
                        <div onclick="showSummaryDetails('3 Months', ${forecast.summary.total_3_months || 0}, '${forecast.summary.overall_risk || 'MEDIUM'}')" 
                             style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;"
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 35px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)'">
                            <div style="font-size: 24px; margin-bottom: 10px;"></div>
                            <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${formatAmount(forecast.summary.total_3_months || 0)}</div>
                            <div style="font-size: 16px; opacity: 0.9;">Next 3 Months</div>
                            <div style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; margin-top: 10px; font-size: 12px;">
                                ${forecast.summary.overall_risk || 'MEDIUM'} Risk
                            </div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 8px;"> Click for details</div>
                        </div>
                    </div>

                    <!-- Quick Info Bar -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 30px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;"></span>
                            <span style="font-weight: 500;">${forecast.summary.data_source || 'Bank Data'}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;"></span>
                            <span style="font-weight: 500;">${forecast.summary.data_quality || 'GOOD'} Quality</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;"></span>
                            <span style="font-weight: 500;">${forecast.summary.data_points || 0} Transactions</span>
                        </div>
                    </div>
            `;

            // Add Daily Forecast - Simple Version
            if (forecast.daily_forecast && forecast.daily_forecast.forecasts && Array.isArray(forecast.daily_forecast.forecasts)) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 5px;">
                             Daily Forecast (Next 7 Days)
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                `;
                
                forecast.daily_forecast.forecasts.slice(0, 7).forEach((day, index) => {
                    const riskColor = day.risk_level === 'HIGH' ? '#ff6b6b' : day.risk_level === 'MEDIUM' ? '#ffd93d' : '#6bcf7f';
                    html += `
                        <div onclick="showDayDetails('${day.day_name}', ${day.predicted_amount}, ${day.confidence}, '${day.risk_level}', ${index})" 
                             style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid ${riskColor}; cursor: pointer; transition: all 0.3s ease;"
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">${day.day_name}</div>
                            <div style="font-size: 20px; font-weight: bold; color: #667eea; margin-bottom: 5px;">${formatAmount(day.predicted_amount)}</div>
                            <div style="font-size: 12px; color: #666;">${(day.confidence * 100).toFixed(0)}% confidence</div>
                            <div style="font-size: 10px; color: #999; margin-top: 5px;"> Click for details</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }

            // Add Weekly Forecast - Simple Version
            if (forecast.weekly_forecast && forecast.weekly_forecast.forecasts && Array.isArray(forecast.weekly_forecast.forecasts)) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333; border-bottom: 2px solid #f093fb; padding-bottom: 5px;">
                             Weekly Forecast (Next 4 Weeks)
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                `;
                
                forecast.weekly_forecast.forecasts.slice(0, 4).forEach((week, index) => {
                    const riskColor = week.risk_level === 'HIGH' ? '#ff6b6b' : week.risk_level === 'MEDIUM' ? '#ffd93d' : '#6bcf7f';
                    html += `
                        <div onclick="showWeekDetails(${week.week_number}, ${week.predicted_amount}, ${week.confidence}, '${week.risk_level}', ${index})" 
                             style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid ${riskColor}; cursor: pointer; transition: all 0.3s ease;"
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">Week ${week.week_number}</div>
                            <div style="font-size: 20px; font-weight: bold; color: #f093fb; margin-bottom: 5px;">${formatAmount(week.predicted_amount)}</div>
                            <div style="font-size: 12px; color: #666;">${(week.confidence * 100).toFixed(0)}% confidence</div>
                            <div style="font-size: 10px; color: #999; margin-top: 5px;"> Click for details</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }

            // Add Key Insights
            html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-top: 30px;">
                        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 15px;"> Key Insights</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">Forecast Method</div>
                                <div style="font-size: 14px; opacity: 0.9;">${forecast.summary.forecast_method || 'Statistical + ML Enhanced'}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">Generated On</div>
                                <div style="font-size: 14px; opacity: 0.9;">${forecast.summary.forecast_generated_at || new Date().toLocaleString()}</div>
                            </div>
                            ${forecast.summary.risk_factors && forecast.summary.risk_factors.length > 0 ? `
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">Risk Factors</div>
                                <div style="font-size: 14px; opacity: 0.9;">${forecast.summary.risk_factors.slice(0, 2).join(', ')}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            resultsContent.innerHTML = html;
        }

        async function runPaymentDelayPrediction() {
            showAlert('Payment Delay Prediction - Coming in Phase 1!', 'info');
        }

        function downloadPredictions(type) {
            showAlert(`${type.replace('_', ' ').toUpperCase()} - Download coming soon!`, 'info');
        }

        async function downloadForecastReport() {
            try {
                showAlert(' Generating forecast report...', 'info');
                
                const response = await fetch('/download-forecast-report');
                
                if (response.ok) {
                    // Get the filename from the response headers
                    const contentDisposition = response.headers.get('content-disposition');
                    let filename = 'Cash_Flow_Forecast_Report.xlsx';
                    
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }
                    
                    // Create blob and download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showAlert(` Forecast report downloaded: ${filename}`, 'success');
                } else {
                    const errorData = await response.json();
                    showAlert(` Download failed: ${errorData.message}`, 'error');
                }
            } catch (error) {
                console.error('Download error:', error);
                showAlert(' Download failed. Please try again.', 'error');
            }
        }

        function displayPredictionsResults(type, data) {
            const resultsArea = document.getElementById('dashboardResultsArea');
            const resultsContent = document.getElementById('resultsContent');
            const resultsHeader = document.getElementById('resultsHeader');
            const resultsTitle = document.getElementById('resultsTitle');
            
            if (type === 'anomaly_detection') {
                // Store anomaly data globally for modal access
                window.currentAnomalyData = data;
                
                // Create beautiful anomaly dashboard
                let anomalyHtml = `
                    <div class="anomaly-dashboard" style="font-family: Arial, sans-serif; max-width: 100%; overflow-x: hidden;">
                        <!-- Main Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div onclick="showAnomalyDetails('high', ${data.severity_breakdown.high || 0})" 
                                 style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 35px rgba(0,0,0,0.15)'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)'">
                                <div style="font-size: 24px; margin-bottom: 10px;"></div>
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${data.severity_breakdown.high || 0}</div>
                                <div style="font-size: 16px; opacity: 0.9;">High Risk Anomalies</div>
                                <div style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; margin-top: 10px; font-size: 12px;">
                                    CRITICAL
                                </div>
                                <div style="font-size: 10px; opacity: 0.8; margin-top: 8px;"> Click for details</div>
                            </div>
                            
                            <div onclick="showAnomalyDetails('medium', ${data.severity_breakdown.medium || 0})" 
                                 style="background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 35px rgba(0,0,0,0.15)'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)'">
                                <div style="font-size: 24px; margin-bottom: 10px;"></div>
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${data.severity_breakdown.medium || 0}</div>
                                <div style="font-size: 16px; opacity: 0.9;">Medium Risk Anomalies</div>
                                <div style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; margin-top: 10px; font-size: 12px;">
                                    WARNING
                                </div>
                                <div style="font-size: 10px; opacity: 0.8; margin-top: 8px;"> Click for details</div>
                            </div>
                            
                            <div onclick="showAnomalyDetails('low', ${data.severity_breakdown.low || 0})" 
                                 style="background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 35px rgba(0,0,0,0.15)'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)'">
                                <div style="font-size: 24px; margin-bottom: 10px;"></div>
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${data.severity_breakdown.low || 0}</div>
                                <div style="font-size: 16px; opacity: 0.9;">Low Risk Anomalies</div>
                                <div style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; margin-top: 10px; font-size: 12px;">
                                    INFO
                                </div>
                                <div style="font-size: 10px; opacity: 0.8; margin-top: 8px;"> Click for details</div>
                            </div>
                        </div>

                        <!-- Quick Info Bar -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 18px;"></span>
                                <span style="font-weight: 500;">AI-Powered Detection</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 18px;"></span>
                                <span style="font-weight: 500;">${data.total_anomalies || 0} Total Anomalies</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 18px;"></span>
                                <span style="font-weight: 500;">${data.processing_time || 'Fast'} Processing</span>
                            </div>
                        </div>
                        
                        ${(data.total_anomalies || 0) > 0 ? `
                        <!-- Where to Check Guidance -->
                        <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 1px solid #ffc107; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <span style="font-size: 20px; margin-right: 10px;"></span>
                                <span style="font-weight: bold; color: #856404; font-size: 16px;">Where to Check for Anomalies:</span>
                            </div>
                            <div style="color: #856404; font-size: 14px; line-height: 1.5;">
                                <div style="margin-bottom: 8px;"><strong> SAP System:</strong> Check vendor master data, transaction history, and chart of accounts</div>
                                <div style="margin-bottom: 8px;"><strong> Bank Statements:</strong> Verify transactions match with bank records</div>
                                <div style="margin-bottom: 8px;"><strong> Reports:</strong> Review AP/AR reports and reconciliation statements</div>
                                <div><strong> Departments:</strong> Contact Finance, Procurement, and IT teams for verification</div>
                            </div>
                        </div>
                        ` : ''}
                        

                        
                        <!-- Analysis Summary -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border">
                            <h5 class="mb-3 font-bold text-gray-800">
                                <i class="fas fa-chart-bar text-blue-600"></i> Analysis Summary
                            </h5>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="font-semibold text-gray-700 mb-1">Total Anomalies</div>
                                    <div class="text-2xl font-bold text-blue-600">${data.total_anomalies}</div>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="font-semibold text-gray-700 mb-1">Total Transactions</div>
                                    <div class="text-2xl font-bold text-green-600">${data.analysis_summary.total_transactions}</div>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="font-semibold text-gray-700 mb-1">Amount Range</div>
                                    <div class="text-sm text-gray-600">${data.analysis_summary.amount_range}</div>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="font-semibold text-gray-700 mb-1">Processing Time</div>
                                    <div class="text-sm text-gray-600">${data.processing_time}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI/ML Performance -->
                        ${data.ai_ml_metrics && data.ai_ml_metrics.ai_powered ? `
                        <div class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border">
                            <h5 class="mb-3 font-bold text-gray-800">
                                <i class="fas fa-robot text-purple-600"></i> AI/ML Performance with Hyperparameter Optimization
                            </h5>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="font-semibold text-gray-700 mb-1">AI Models Used</div>
                                    <div class="text-sm text-purple-600">${data.ai_ml_metrics.models_used.join(', ')} (optimized)</div>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="font-semibold text-gray-700 mb-1">Features Analyzed</div>
                                    <div class="text-2xl font-bold text-purple-600">${data.ai_ml_metrics.features_used}</div>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="font-semibold text-gray-700 mb-1">AI Detected</div>
                                    <div class="text-2xl font-bold text-pink-600">${data.ai_ml_metrics.ml_anomalies}</div>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm">
                                    <div class="font-semibold text-gray-700 mb-1">Statistical</div>
                                    <div class="text-2xl font-bold text-blue-600">${data.ai_ml_metrics.statistical_anomalies}</div>
                                </div>
                            </div>
                            
                            <!-- Model Verification Details -->
                            ${data.ai_ml_metrics.model_verification ? `
                            <div class="mt-4 p-3 bg-white rounded border">
                                <h6 class="font-semibold text-gray-800 mb-2">
                                    <i class="fas fa-microscope text-blue-600"></i> Model Verification & Optimization
                                </h6>
                                <div class="grid grid-cols-3 gap-3 text-xs">
                                    <div class="bg-blue-50 p-2 rounded">
                                        <div class="font-semibold">Isolation Forest</div>
                                        <div class="text-blue-600">${data.ai_ml_metrics.model_verification.isolation_forest_anomalies} anomalies</div>
                                    </div>
                                    <div class="bg-green-50 p-2 rounded">
                                        <div class="font-semibold">Local Outlier Factor</div>
                                        <div class="text-green-600">${data.ai_ml_metrics.model_verification.lof_anomalies} anomalies</div>
                                    </div>
                                    <div class="bg-purple-50 p-2 rounded">
                                        <div class="font-semibold">One-Class SVM</div>
                                        <div class="text-purple-600">${data.ai_ml_metrics.model_verification.svm_anomalies} anomalies</div>
                                    </div>
                                    <div class="bg-orange-50 p-2 rounded">
                                        <div class="font-semibold">DBSCAN</div>
                                        <div class="text-orange-600">${data.ai_ml_metrics.model_verification.dbscan_anomalies} anomalies</div>
                                    </div>
                                    <div class="bg-gray-50 p-2 rounded">
                                        <div class="font-semibold">Training Samples</div>
                                        <div class="text-gray-600">${data.ai_ml_metrics.model_verification.training_samples}</div>
                                    </div>
                                    <div class="bg-indigo-50 p-2 rounded">
                                        <div class="font-semibold">Features Used</div>
                                        <div class="text-indigo-600">${data.ai_ml_metrics.model_verification.feature_count}</div>
                                    </div>
                                </div>
                                
                                <!-- Hyperparameter Optimization Details -->
                                ${data.ai_ml_metrics.model_verification.hyperparameter_optimization ? `
                                <div class="mt-3 p-3 bg-gradient-to-r from-green-50 to-blue-50 rounded border">
                                    <h6 class="font-semibold text-gray-800 mb-2">
                                        <i class="fas fa-cogs text-green-600"></i> Hyperparameter Optimization
                                    </h6>
                                    <div class="grid grid-cols-2 gap-3 text-xs">
                                        <div class="bg-white p-2 rounded shadow-sm">
                                            <div class="font-semibold text-gray-700">Ensemble Models</div>
                                            <div class="text-green-600 font-bold">${data.ai_ml_metrics.model_verification.hyperparameter_optimization.ensemble_models} models</div>
                                        </div>
                                        <div class="bg-white p-2 rounded shadow-sm">
                                            <div class="font-semibold text-gray-700">Adaptive Contamination</div>
                                            <div class="text-blue-600 font-bold">${data.ai_ml_metrics.model_verification.hyperparameter_optimization.adaptive_contamination.toFixed(3)}</div>
                                        </div>
                                        ${data.ai_ml_metrics.model_verification.hyperparameter_optimization.best_params ? `
                                        <div class="col-span-2 bg-white p-2 rounded shadow-sm">
                                            <div class="font-semibold text-gray-700 mb-1">Optimized Parameters</div>
                                            <div class="text-xs space-y-1">
                                                ${data.ai_ml_metrics.model_verification.hyperparameter_optimization.best_params.isolation_forest ? 
                                                    `<div><span class="font-semibold">IF:</span> cont=${data.ai_ml_metrics.model_verification.hyperparameter_optimization.best_params.isolation_forest.contamination}, n_est=${data.ai_ml_metrics.model_verification.hyperparameter_optimization.best_params.isolation_forest.n_estimators}</div>` : ''}
                                                ${data.ai_ml_metrics.model_verification.hyperparameter_optimization.best_params.lof ? 
                                                    `<div><span class="font-semibold">LOF:</span> cont=${data.ai_ml_metrics.model_verification.hyperparameter_optimization.best_params.lof.contamination}, n_neigh=${data.ai_ml_metrics.model_verification.hyperparameter_optimization.best_params.lof.n_neighbors}</div>` : ''}
                                                ${data.ai_ml_metrics.model_verification.hyperparameter_optimization.best_params.one_class_svm ? 
                                                    `<div><span class="font-semibold">SVM:</span> nu=${data.ai_ml_metrics.model_verification.hyperparameter_optimization.best_params.one_class_svm.nu}, kernel=${data.ai_ml_metrics.model_verification.hyperparameter_optimization.best_params.one_class_svm.kernel}</div>` : ''}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}
                        </div>
                        ` : `
                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                <span class="text-sm text-yellow-800">Using enhanced statistical methods (AI/ML libraries not available)</span>
                            </div>
                        </div>
                        `}
                        

                    </div>
                `;

                resultsTitle.textContent = 'Anomaly Detection Results';
                resultsContent.innerHTML = anomalyHtml;
                resultsHeader.style.display = 'flex';
                
                const backdrop = document.getElementById('dashboardBackdrop');
                backdrop.classList.add('show');
                resultsArea.classList.add('show');
            }
        }

        function filterAnomalies(severity) {
            const anomalies = document.querySelectorAll('.anomaly-item');
            const filterButtons = document.querySelectorAll('.anomaly-filters .btn');
            
            // Update active filter button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filter anomalies
            anomalies.forEach(anomaly => {
                if (anomaly.dataset.severity === severity) {
                    anomaly.style.display = 'block';
                } else {
                    anomaly.style.display = 'none';
                }
            });
        }


        // Replace the existing downloadOrphanedPayments function in your HTML with this fixed version:

function downloadOrphanedPayments() {
    console.log("Starting orphaned payments download...");
    
    // Show loading message
    showAlert('Preparing orphaned payments download...', 'info');
    
    // Create a temporary status indicator
    const statusDiv = document.createElement('div');
    statusDiv.id = 'orphanedDownloadStatus';
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Preparing download...</div>';
    document.getElementById('messageContainer').appendChild(statusDiv);
    
    fetch('/download_orphaned_payments', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log("Response status:", response.status);
        console.log("Response headers:", response.headers);
        
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
            });
        }
        
        // Check if response is actually a blob
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')) {
            throw new Error('Invalid response format. Expected Excel file.');
        }
        
        return response.blob();
    })
    .then(blob => {
        console.log("Blob received, size:", blob.size);
        
        if (blob.size === 0) {
            throw new Error('Downloaded file is empty');
        }
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Orphaned_Payments_Analysis_${new Date().toISOString().slice(0, 10)}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Update status
        statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Download completed successfully!</div>';
        showAlert('Orphaned payments analysis downloaded successfully!', 'success');
        
        // Remove status after 3 seconds
        setTimeout(() => {
            statusDiv.remove();
        }, 3000);
    })
    .catch(error => {
        console.error('Download error:', error);
        
        // Update status with error
        statusDiv.innerHTML = `<div class="alert alert-error"><i class="fas fa-exclamation-triangle"></i> Download failed: ${error.message}</div>`;
        showAlert(`Download failed: ${error.message}`, 'error');
        
        // Remove status after 5 seconds
        setTimeout(() => {
            statusDiv.remove();
        }, 5000);
    });
}

// Also add this helper function to check if invoice-payment data exists before downloading
async function checkInvoicePaymentData() {
    try {
        const response = await fetch('/status');
        const data = await response.json();
        
        if (response.ok) {
            if (data.invoice_payment_matching_available) {
                return true;
            } else {
                showAlert('Please run invoice-payment matching first before downloading orphaned payments.', 'warning');
                return false;
            }
        } else {
            showAlert('Error checking system status', 'error');
            return false;
        }
    } catch (error) {
        showAlert(`Status check error: ${error.message}`, 'error');
        return false;
    }
}

// Enhanced downloadOrphanedPayments with data check
async function downloadOrphanedPaymentsEnhanced() {
    // First check if invoice-payment data exists
    const dataExists = await checkInvoicePaymentData();
    
    if (!dataExists) {
        return;
    }
    
    // Proceed with download
    downloadOrphanedPayments();
}
        function updateSummaryCards(summary) {
            // Update summary cards with real data
            const totalTransactions = summary.sap_transactions + summary.bank_transactions;
            const reconciledAmount = summary.exact_matches + summary.fuzzy_matches;
            const pendingReviews = summary.sap_transactions - reconciledAmount;
            
            document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
            document.getElementById('reconciledAmount').textContent = `$${(reconciledAmount * 1000).toLocaleString()}`;
            document.getElementById('pendingReviews').textContent = pendingReviews.toLocaleString();
            document.getElementById('activeUsers').textContent = '1';
            
            // Update trends (you can calculate real trends based on your data)
            document.getElementById('transactionsTrend').textContent = '+5.2%';
            document.getElementById('reconciledTrend').textContent = '+12.1%';
            document.getElementById('pendingTrend').textContent = '-8.3%';
            document.getElementById('usersTrend').textContent = '+2.7%';
        }

        function displaySummaryDashboard(summary) {
            const dashboard = document.getElementById('summaryDashboard');
            const statsContainer = document.getElementById('summaryStats');
            
            // Safety check for required elements
            if (!statsContainer) {
                console.error('summaryStats element not found');
                return;
            }
            
            statsContainer.innerHTML = `
                <div onclick="showSAPDetails('SAP Transactions', ${summary.sap_transactions}, 'sap')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-database stat-icon"></i>
                    <span class="stat-number">${summary.sap_transactions}</span>
                    <span class="stat-label">SAP Transactions</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showBankDetails('Bank Transactions', ${summary.bank_transactions}, 'bank')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-university stat-icon"></i>
                    <span class="stat-number">${summary.bank_transactions}</span>
                    <span class="stat-label">Bank Transactions</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showMatchDetails('Exact Matches', ${summary.exact_matches}, 'exact')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-check-double stat-icon"></i>
                    <span class="stat-number">${summary.exact_matches}</span>
                    <span class="stat-label">Exact Matches</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showMatchDetails('Fuzzy Matches', ${summary.fuzzy_matches}, 'fuzzy')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-search stat-icon"></i>
                    <span class="stat-number">${summary.fuzzy_matches}</span>
                    <span class="stat-label">Fuzzy Matches</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showMatchRateDetails('Match Rate', ${summary.match_rate}, 'rate')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-percentage stat-icon"></i>
                    <span class="stat-number">${summary.match_rate}%</span>
                    <span class="stat-label">Match Rate</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showAICategorizedDetails('AI Categorized', ${summary.ai_usage_stats?.ai_categorized || 0}, 'ai')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-robot stat-icon"></i>
                    <span class="stat-number">${summary.ai_usage_stats?.ai_categorized || 0}</span>
                    <span class="stat-label">AI Categorized</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
            `;
            
            dashboard.classList.remove('hidden');
        }

        // Utility Functions
        function showAlert(message, type) {
            // Remove any existing popup alerts
            const existingAlerts = document.querySelectorAll('.popup-alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `popup-alert ${type}`;
            
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'error' ? 'exclamation-triangle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';
            
            alertDiv.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <div class="alert-content">
                    <span>${message}</span>
                </div>
                <button class="close-alert" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Show the alert with animation
            setTimeout(() => {
                alertDiv.classList.add('show');
            }, 10);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => {
                        if (alertDiv.parentElement) {
                            alertDiv.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (show) {
                loadingIndicator.classList.add('show');
            } else {
                loadingIndicator.classList.remove('show');
            }
        }

        function showProgress(type, show) {
            const progressElement = document.getElementById(type + 'Progress');
            if (show) {
                progressElement.classList.add('show');
            } else {
                progressElement.classList.remove('show');
                updateProgressBar(type, 0);
            }
        }

        function updateProgressBar(type, percentage) {
            const progressBar = document.getElementById(type + 'ProgressBar');
            progressBar.style.width = percentage + '%';
        }

        function showWelcomeMessage() {
            showAlert('Enterprise SAP-Bank Reconciliation Platform Ready! Upload bank statement to begin analysis.', 'info');
        }

        async function viewCategoryData(dataType) {
            try {
                showLoading(true);
                const response = await fetch(`/view/${dataType}`);
                const data = await response.json();
                if (response.ok) {
                    displayCategoryBreakdown(data, dataType);
                } else {
                    showAlert(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayCategoryBreakdown(data, dataType) {
            const resultsArea = document.getElementById('dashboardResultsArea');
            const resultsContent = document.getElementById('resultsContent');
            const resultsHeader = document.getElementById('resultsHeader');
            const resultsTitle = document.getElementById('resultsTitle');
            
            let content = '';
            let title = 'Analysis Results';
            
            if (data.type === 'category_breakdown') {
                content = generateCategoryBreakdownHTML(data, dataType);
                title = dataType.replace('_', ' ').toUpperCase() + ' Analysis';
            } else if (data.type === 'cash_flow_breakdown') {
                content = generateCashFlowBreakdownHTML(data);
                title = 'Cash Flow Analysis';
            } else if (data.type === 'vendor_cash_flow_breakdown') {
                content = generateCashFlowBreakdownHTML(data);
                title = 'Vendor Cash Flow Analysis';
            }
            
            resultsTitle.textContent = title;
            resultsContent.innerHTML = content;
            resultsHeader.style.display = 'flex';
            
            const backdrop = document.getElementById('dashboardBackdrop');
            backdrop.classList.add('show');
            resultsArea.classList.add('show');
            
            // Initialize category tabs
            initializeCategoryTabs();
        }

        function showDashboardResults(title, content) {
            const resultsArea = document.getElementById('dashboardResultsArea');
            const resultsContent = document.getElementById('resultsContent');
            const resultsHeader = document.getElementById('resultsHeader');
            const resultsTitle = document.getElementById('resultsTitle');
            
            resultsTitle.textContent = title;
            resultsContent.innerHTML = content;
            resultsHeader.style.display = 'flex';
            
            const backdrop = document.getElementById('dashboardBackdrop');
            backdrop.classList.add('show');
            resultsArea.classList.add('show');
        }

        function generateCategoryBreakdownHTML(data, dataType) {
            const title = dataType.replace('_', ' ').toUpperCase();
            const breakdown = data.breakdown;
            
            let html = `
                <div class="tab-container">
                    <h3> ${title} - Complete Category Breakdown</h3>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <h4> Summary Statistics</h4>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <span class="stat-number">${data.summary.total_transactions}</span>
                                    <span class="stat-label">Total Transactions</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${data.summary.operating_count}</span>
                                    <span class="stat-label">Operating</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${data.summary.investing_count}</span>
                                    <span class="stat-label">Investing</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${data.summary.financing_count}</span>
                                    <span class="stat-label">Financing</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(data.summary.total_amount)}</span>
                                    <span class="stat-label">Total Amount</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-nav">
                        <button class="tab-button active" data-category="Operating Activities">
                             Operating Activities (${breakdown['Operating Activities'].count})
                        </button>
                        <button class="tab-button" data-category="Investing Activities">
                             Investing Activities (${breakdown['Investing Activities'].count})
                        </button>
                        <button class="tab-button" data-category="Financing Activities">
                             Financing Activities (${breakdown['Financing Activities'].count})
                        </button>
                    </div>
            `;
            
            // Generate content for each category
            Object.keys(breakdown).forEach((category, index) => {
                const categoryData = breakdown[category];
                const isActive = index === 0 ? 'active' : '';
                
                html += `
                    <div class="tab-content ${isActive}" data-category="${category}">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span class="stat-number">${categoryData.count}</span>
                                <span class="stat-label">Transactions</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(categoryData.total)}</span>
                                <span class="stat-label">Net Amount</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(categoryData.inflows)}</span>
                                <span class="stat-label">Inflows</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(categoryData.outflows)}</span>
                                <span class="stat-label">Outflows</span>
                            </div>
                        </div>
                        
                        ${generateTransactionTable(categoryData.transactions, dataType)}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function generateCashFlowBreakdownHTML(data) {
            const breakdown = data.breakdown;
            
            let html = `
                <div class="tab-container">
                    <h3> ${data.vendor_name ? `Vendor: ${data.vendor_name} - ` : ''}${data.type === 'vendor_cash_flow_breakdown' ? 'Vendor Cash Flow' : 'Perfect Cash Flow Statement'} - Category Breakdown</h3>
                    <div class="alert alert-success">
                        <i class="fas fa-chart-line"></i>
                        <div>
                            <h4> Cash Flow Summary</h4>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <span class="stat-number">${data.summary.total_transactions}</span>
                                    <span class="stat-label">Total Transactions</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(data.summary.operating_total)}</span>
                                    <span class="stat-label">Operating Cash Flow</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(data.summary.investing_total)}</span>
                                    <span class="stat-label">Investing Cash Flow</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(data.summary.financing_total)}</span>
                                    <span class="stat-label">Financing Cash Flow</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(data.summary.net_cash_flow)}</span>
                                    <span class="stat-label">Net Cash Flow</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-nav">
                        <button class="tab-button active" data-category="Operating Activities">
                             Operating Activities (${breakdown['Operating Activities'].count})
                        </button>
                        <button class="tab-button" data-category="Investing Activities">
                             Investing Activities (${breakdown['Investing Activities'].count})
                        </button>
                        <button class="tab-button" data-category="Financing Activities">
                             Financing Activities (${breakdown['Financing Activities'].count})
                        </button>
                    </div>
            `;
            
            // Generate content for each category
            Object.keys(breakdown).forEach((category, index) => {
                const categoryData = breakdown[category];
                const isActive = index === 0 ? 'active' : '';
                
                html += `
                    <div class="tab-content ${isActive}" data-category="${category}">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span class="stat-number">${categoryData.count}</span>
                                <span class="stat-label">Transactions</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(categoryData.total)}</span>
                                <span class="stat-label">Net Cash Flow</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(categoryData.inflows)}</span>
                                <span class="stat-label">Cash Inflows</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(categoryData.outflows)}</span>
                                <span class="stat-label">Cash Outflows</span>
                            </div>
                        </div>
                        
                        ${generateTransactionTable(categoryData.transactions, 'cash_flow')}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function generateTransactionTable(transactions, dataType) {
            if (!transactions || transactions.length === 0) {
                return '<div class="alert alert-info"><i class="fas fa-info-circle"></i>No transactions found in this category.</div>';
            }
            
            let tableHtml = '<table class="data-table"><thead><tr>';
            
            // Generate headers based on data type
            if (dataType === 'matched_exact' || dataType === 'matched_fuzzy') {
                tableHtml += `
                    <th>SAP Description</th>
                    <th>SAP Amount</th>
                    <th>Bank Description</th>
                    <th>Bank Amount</th>
                    <th>Match Score</th>
                    <th>Category</th>
                `;
            } else if (dataType === 'unmatched_sap' || dataType === 'unmatched_bank') {
                tableHtml += `
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Reason</th>
                `;
            } else {
                tableHtml += `
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Category</th>
                `;
            }
            
            tableHtml += '</tr></thead><tbody>';
            
            // Generate rows - showing ALL transactions
            transactions.forEach(transaction => {
                tableHtml += '<tr>';
                
                if (dataType === 'matched_exact' || dataType === 'matched_fuzzy') {
                    tableHtml += `
                        <td>${transaction.SAP_Description || transaction.Description || ''}</td>
                        <td class="${transaction.SAP_Amount >= 0 ? 'amount-positive' : 'amount-negative'}">${formatAmount(transaction.SAP_Amount || transaction.Amount || 0)}</td>
                        <td>${transaction.Bank_Description || ''}</td>
                        <td class="${transaction.Bank_Amount >= 0 ? 'amount-positive' : 'amount-negative'}">${formatAmount(transaction.Bank_Amount || 0)}</td>
                        <td><span class="match-score">${(transaction.Match_Score || 0).toFixed(3)}</span></td>
                        <td>${formatCategoryWithAI(transaction.Category || '')}</td>
                    `;
                } else if (dataType === 'unmatched_sap' || dataType === 'unmatched_bank') {
                    tableHtml += `
                        <td>${transaction.Description || ''}</td>
                        <td class="${transaction.Amount >= 0 ? 'amount-positive' : 'amount-negative'}">${formatAmount(transaction.Amount || 0)}</td>
                        <td>${transaction.Date || ''}</td>
                        <td>${formatCategoryWithAI(transaction.Category || '')}</td>
                        <td>${transaction.Reason || ''}</td>
                    `;
                } else {
                    tableHtml += `
                        <td>${transaction.Description || ''}</td>
                        <td class="${transaction.Amount >= 0 ? 'amount-positive' : 'amount-negative'}">${formatAmount(transaction.Amount || 0)}</td>
                        <td>${transaction.Date || ''}</td>
                        <td>${formatCategoryWithAI(transaction.Category || '')}</td>
                    `;
                }
                
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table>';
            tableHtml += `<p style="margin-top: 10px; font-style: italic; color: #666;">Showing all ${transactions.length} transactions in this category</p>`;
            
            return tableHtml;
        }

        function formatCategoryWithAI(category) {
            if (category.includes('(AI)')) {
                const baseCategory = category.replace(' (AI)', '');
                return `${baseCategory} <span style="background: #9b59b6; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; font-weight: bold;"> AI</span>`;
            }
            return `${category} <span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; font-weight: bold;"> RULE</span>`;
        }

        function initializeCategoryTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetCategory = this.dataset.category;
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding content
                    const targetContent = document.querySelector(`[data-category="${targetCategory}"].tab-content`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }

        function formatAmount(amount) {
            if (amount === null || amount === undefined) return '0.00';
            const num = parseFloat(amount);
            return num.toLocaleString('en-US', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        }

        function showDayDetails(dayName, amount, confidence, riskLevel, index) {
            const riskColor = riskLevel === 'HIGH' ? '#ff6b6b' : riskLevel === 'MEDIUM' ? '#ffd93d' : '#6bcf7f';
            const riskEmoji = riskLevel === 'HIGH' ? '' : riskLevel === 'MEDIUM' ? '' : '';
            
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${dayName} Details</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${(amount / 10000000).toFixed(2)} Cr</div>
                            <div style="font-size: 16px; opacity: 0.9;">Predicted Cash Flow</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;"></div>
                                <div style="font-weight: bold; color: #333;">${(confidence * 100).toFixed(0)}%</div>
                                <div style="font-size: 12px; color: #666;">Confidence</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;">${riskEmoji}</div>
                                <div style="font-weight: bold; color: #333;">${riskLevel}</div>
                                <div style="font-size: 12px; color: #666;">Risk Level</div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Position:</strong> Day ${index + 1} of the week</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Amount:</strong> ${(amount / 10000000).toFixed(2)} Crores</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Confidence:</strong> ${confidence < 0.3 ? 'Low' : confidence < 0.7 ? 'Medium' : 'High'} reliability</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Risk:</strong> ${riskLevel} risk level</li>
                                <li style="padding: 8px 0;"> <strong>Day Type:</strong> ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].includes(dayName) ? 'Weekday' : 'Weekend'}</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Recommendations</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                ${confidence < 0.3 ? ' Consider this forecast with caution due to low confidence. Review historical data for similar days.' : 
                                  confidence < 0.7 ? ' Moderate confidence level. Monitor actual vs predicted performance.' : 
                                  ' High confidence forecast. Plan cash management accordingly.'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalHtml);
        }

        function showWeekDetails(weekNumber, amount, confidence, riskLevel, index) {
            const riskColor = riskLevel === 'HIGH' ? '#ff6b6b' : riskLevel === 'MEDIUM' ? '#ffd93d' : '#6bcf7f';
            const riskEmoji = riskLevel === 'HIGH' ? '' : riskLevel === 'MEDIUM' ? '' : '';
            
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> Week ${weekNumber} Details</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${(amount / 10000000).toFixed(2)} Cr</div>
                            <div style="font-size: 16px; opacity: 0.9;">Weekly Cash Flow Forecast</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;"></div>
                                <div style="font-weight: bold; color: #333;">${(confidence * 100).toFixed(0)}%</div>
                                <div style="font-size: 12px; color: #666;">Confidence</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;">${riskEmoji}</div>
                                <div style="font-weight: bold; color: #333;">${riskLevel}</div>
                                <div style="font-size: 12px; color: #666;">Risk Level</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;"></div>
                                <div style="font-weight: bold; color: #333;">Week ${weekNumber}</div>
                                <div style="font-size: 12px; color: #666;">Period</div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Weekly Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Week Position:</strong> ${index + 1} of 4 weeks</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Total Amount:</strong> ${(amount / 10000000).toFixed(2)} Crores</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Confidence:</strong> ${confidence < 0.3 ? 'Low' : confidence < 0.7 ? 'Medium' : 'High'} reliability</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Risk:</strong> ${riskLevel} risk level</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Daily Average:</strong> ${((amount / 7) / 10000000).toFixed(2)} Cr per day</li>
                                <li style="padding: 8px 0;"> <strong>Trend:</strong> ${index === 0 ? 'First week' : index === 1 ? 'Second week' : index === 2 ? 'Third week' : 'Fourth week'} of forecast</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Strategic Insights</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                ${confidence >= 0.8 ? ' High confidence forecast - Plan major cash operations for this week.' : 
                                  confidence >= 0.6 ? ' Moderate confidence - Monitor daily performance and adjust plans.' : 
                                  ' Lower confidence - Review historical patterns and consider conservative planning.'}
                                <br><br>
                                <strong>Cash Management Tips:</strong><br>
                                 Plan for ${((amount / 7) / 10000000).toFixed(2)} Cr daily average<br>
                                 Monitor actual vs predicted performance<br>
                                 Adjust strategies based on ${riskLevel.toLowerCase()} risk level
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalHtml);
        }

        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            if (modal) {
                modal.remove();
            }
        }

        // Helper function to safely show modals
        function showModal(modalHtml) {
            try {
                // Remove any existing modal first
                closeDetailModal();
                
                // Add the new modal
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Add click outside to close functionality
                const modal = document.getElementById('detailModal');
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeDetailModal();
                        }
                    });
                }
            } catch (error) {
                console.error('Error showing modal:', error);
                // Fallback: show a simple alert
                alert('Unable to display detailed information. Please try again.');
            }
        }

        // Simple test function to verify modals work
        function testModal() {
            const testModalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; text-align: center;">
                        <h2 style="color: #333; margin-bottom: 20px;"> Modal Test</h2>
                        <p style="margin-bottom: 20px;">Modal system is working correctly!</p>
                        <button onclick="closeDetailModal()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Close</button>
                    </div>
                </div>
            `;
            showModal(testModalHtml);
        }



        // AP/AR Detail Modal Functions
        function showAPDetails(title, amount, transactionCount) {
            // Safety checks for parameters
            if (typeof amount !== 'number' || isNaN(amount)) {
                amount = 0;
            }
            if (typeof transactionCount !== 'string' && typeof transactionCount !== 'number') {
                transactionCount = '0';
            }
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${(amount / 10000000).toFixed(2)} Cr</div>
                            <div style="font-size: 16px; opacity: 0.9;">Outstanding Amount</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> AP Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> Accounts Payable</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Amount:</strong> ${(amount / 10000000).toFixed(2)} Crores</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Transactions:</strong> ${transactionCount}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Status:</strong> Outstanding</li>
                                <li style="padding: 8px 0;"> <strong>Action Required:</strong> Payment processing</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #ff9ff3 0%, #f368e0 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Recommendations</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Prioritize payments based on due dates<br>
                                 Monitor cash flow for payment capacity<br>
                                 Review vendor payment terms<br>
                                 Consider early payment discounts
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showARDetails(title, amount, transactionCount) {
            // Safety checks for parameters
            if (typeof amount !== 'number' || isNaN(amount)) {
                amount = 0;
            }
            if (typeof transactionCount !== 'string' && typeof transactionCount !== 'number') {
                transactionCount = '0';
            }
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${(amount / 10000000).toFixed(2)} Cr</div>
                            <div style="font-size: 16px; opacity: 0.9;">Receivable Amount</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> AR Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> Accounts Receivable</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Amount:</strong> ${(amount / 10000000).toFixed(2)} Crores</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Transactions:</strong> ${transactionCount}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Status:</strong> Outstanding</li>
                                <li style="padding: 8px 0;"> <strong>Action Required:</strong> Collection follow-up</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Recommendations</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Implement collection strategies<br>
                                 Send payment reminders<br>
                                 Review credit policies<br>
                                 Monitor aging reports
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showTotalOutstandingDetails(title, amount, transactionCount) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${(amount / 10000000).toFixed(2)} Cr</div>
                            <div style="font-size: 16px; opacity: 0.9;">Combined Outstanding</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Total Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> Combined AP + AR</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Amount:</strong> ${(amount / 10000000).toFixed(2)} Crores</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Transactions:</strong> ${transactionCount}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Net Position:</strong> AP vs AR balance</li>
                                <li style="padding: 8px 0;"> <strong>Impact:</strong> Working capital</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Strategic Insights</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Monitor working capital position<br>
                                 Balance payment and collection cycles<br>
                                 Optimize cash flow timing<br>
                                 Review credit and payment terms
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showEfficiencyDetails(title, percentage, type) {
            // Safety checks for parameters
            if (typeof percentage !== 'number' || isNaN(percentage)) {
                percentage = 0;
            }
            if (typeof type !== 'string') {
                type = 'collection';
            }
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${percentage.toFixed(1)}%</div>
                            <div style="font-size: 16px; opacity: 0.9;">${type === 'collection' ? 'Collection' : 'Payment'} Efficiency</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Performance Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Metric:</strong> ${type === 'collection' ? 'Collection' : 'Payment'} Efficiency</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Score:</strong> ${percentage.toFixed(1)}%</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Status:</strong> ${percentage >= 80 ? 'Excellent' : percentage >= 60 ? 'Good' : percentage >= 40 ? 'Fair' : 'Poor'}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> ${type === 'collection' ? 'Receivables' : 'Payables'} management</li>
                                <li style="padding: 8px 0;"> <strong>Focus:</strong> Process optimization</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Improvement Strategies</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                ${type === 'collection' ? 
                                    ' Implement automated reminders<br> Review credit policies<br> Optimize collection processes<br> Monitor aging reports' :
                                    ' Streamline payment processes<br> Negotiate better terms<br> Optimize cash flow timing<br> Monitor payment cycles'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showOverdueDetails(title, amount, transactionCount) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${(amount / 10000000).toFixed(2)} Cr</div>
                            <div style="font-size: 16px; opacity: 0.9;">Overdue Amount</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Risk Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Risk Level:</strong> High</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Amount:</strong> ${(amount / 10000000).toFixed(2)} Crores</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Transactions:</strong> ${transactionCount}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Age:</strong> 90+ days overdue</li>
                                <li style="padding: 8px 0;"> <strong>Action:</strong> Immediate attention required</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #ff9ff3 0%, #f368e0 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Urgent Actions</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Immediate collection follow-up<br>
                                 Legal action consideration<br>
                                 Credit limit review<br>
                                 Process improvement
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        // Vendor Cash Flow Detail Modal Functions
        function showVendorDetails(title, count, type) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${count}</div>
                            <div style="font-size: 16px; opacity: 0.9;">Total Vendors</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Vendor Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Total Vendors:</strong> ${count}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> Vendor relationships</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Status:</strong> Active analysis</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Focus:</strong> Cash flow patterns</li>
                                <li style="padding: 8px 0;"> <strong>Insight:</strong> Vendor performance tracking</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Vendor Management</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Monitor vendor performance<br>
                                 Analyze payment patterns<br>
                                 Optimize vendor relationships<br>
                                 Track cash flow impact
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showTransactionDetails(title, count, type) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${count}</div>
                            <div style="font-size: 16px; opacity: 0.9;">Total Transactions</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Transaction Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Total Transactions:</strong> ${count}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> Vendor transactions</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Status:</strong> Analyzed</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Focus:</strong> Pattern analysis</li>
                                <li style="padding: 8px 0;"> <strong>Insight:</strong> Transaction volume</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Transaction Insights</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Analyze transaction patterns<br>
                                 Monitor volume trends<br>
                                 Identify peak periods<br>
                                 Optimize processing
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showAmountDetails(title, amount, type) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${(amount / 10000000).toFixed(2)} Cr</div>
                            <div style="font-size: 16px; opacity: 0.9;">Total Amount</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Amount Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Total Amount:</strong> ${(amount / 10000000).toFixed(2)} Crores</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> Vendor transactions</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Status:</strong> Analyzed</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Focus:</strong> Financial impact</li>
                                <li style="padding: 8px 0;"> <strong>Insight:</strong> Cash flow magnitude</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #ffd93d 0%, #ff6b6b 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Financial Insights</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Monitor total vendor spend<br>
                                 Analyze amount distribution<br>
                                 Track financial trends<br>
                                 Optimize cash flow
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showAIDetails(title, status, type) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${status}</div>
                            <div style="font-size: 16px; opacity: 0.9;">AI Status</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> AI Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>AI Status:</strong> ${status}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> Machine learning</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Function:</strong> Pattern recognition</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Focus:</strong> Data analysis</li>
                                <li style="padding: 8px 0;"> <strong>Benefit:</strong> Enhanced insights</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> AI Capabilities</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Automated pattern recognition<br>
                                 Intelligent categorization<br>
                                 Predictive analytics<br>
                                 Enhanced accuracy
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        // Summary Dashboard Detail Modal Functions
        function showSAPDetails(title, count, type) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${count}</div>
                            <div style="font-size: 16px; opacity: 0.9;">SAP Transactions</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> SAP Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Source:</strong> SAP System</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Transactions:</strong> ${count}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> ERP Data</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Status:</strong> Processed</li>
                                <li style="padding: 8px 0;"> <strong>Purpose:</strong> Reconciliation</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> SAP Insights</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 ERP transaction data<br>
                                 Financial records<br>
                                 System integration<br>
                                 Data accuracy
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showBankDetails(title, count, type) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${count}</div>
                            <div style="font-size: 16px; opacity: 0.9;">Bank Transactions</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Bank Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Source:</strong> Bank Statement</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Transactions:</strong> ${count}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> Banking Data</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Status:</strong> Processed</li>
                                <li style="padding: 8px 0;"> <strong>Purpose:</strong> Reconciliation</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Bank Insights</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Banking transaction data<br>
                                 Cash flow records<br>
                                 Financial reconciliation<br>
                                 Data verification
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showMatchDetails(title, count, type) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, ${type === 'exact' ? '#26de81 0%, #20bf6b 100%' : '#f093fb 0%, #f5576c 100%'}); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${count}</div>
                            <div style="font-size: 16px; opacity: 0.9;">${type === 'exact' ? 'Exact' : 'Fuzzy'} Matches</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Match Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> ${type === 'exact' ? 'Exact' : 'Fuzzy'} Match</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Count:</strong> ${count}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Method:</strong> ${type === 'exact' ? 'Perfect match' : 'Similarity match'}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Confidence:</strong> ${type === 'exact' ? '100%' : 'High'}</li>
                                <li style="padding: 8px 0;"> <strong>Status:</strong> Reconciled</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #ffd93d 0%, #ff6b6b 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Match Insights</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                ${type === 'exact' ? 
                                    ' Perfect data alignment<br> High confidence matches<br> Automated reconciliation<br> Zero manual intervention' :
                                    ' Intelligent matching<br> Pattern recognition<br> Similarity scoring<br> Enhanced accuracy'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showMatchRateDetails(title, rate, type) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${rate}%</div>
                            <div style="font-size: 16px; opacity: 0.9;">Match Rate</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Rate Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Match Rate:</strong> ${rate}%</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Performance:</strong> ${rate >= 80 ? 'Excellent' : rate >= 60 ? 'Good' : rate >= 40 ? 'Fair' : 'Poor'}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> Reconciliation success</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Target:</strong> High accuracy</li>
                                <li style="padding: 8px 0;"> <strong>Impact:</strong> Data quality</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Performance Insights</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Reconciliation accuracy<br>
                                 Data quality metrics<br>
                                 Process efficiency<br>
                                 Continuous improvement
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showAICategorizedDetails(title, count, type) {
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${count}</div>
                            <div style="font-size: 16px; opacity: 0.9;">AI Categorized</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> AI Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>AI Categorized:</strong> ${count}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Type:</strong> Machine learning</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Function:</strong> Auto-categorization</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Accuracy:</strong> High</li>
                                <li style="padding: 8px 0;"> <strong>Benefit:</strong> Time savings</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> AI Benefits</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                 Automated categorization<br>
                                 Intelligent processing<br>
                                 Time efficiency<br>
                                 Enhanced accuracy
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHtml);
        }

        function showSummaryDetails(period, amount, riskLevel) {
            const riskEmoji = riskLevel === 'HIGH' ? '' : riskLevel === 'MEDIUM' ? '' : '';
            
            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0;"> ${period} Summary</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${(amount / 10000000).toFixed(2)} Cr</div>
                            <div style="font-size: 16px; opacity: 0.9;">Total Cash Flow Forecast</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;"> Period Analysis</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Period:</strong> ${period}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Total Amount:</strong> ${(amount / 10000000).toFixed(2)} Crores</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Risk Level:</strong> ${riskLevel} ${riskEmoji}</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;"> <strong>Daily Average:</strong> ${((amount / (period.includes('7') ? 7 : period.includes('4') ? 28 : 90)) / 10000000).toFixed(2)} Cr per day</li>
                                <li style="padding: 8px 0;"> <strong>Forecast Type:</strong> ${period.includes('7') ? 'Short-term' : period.includes('4') ? 'Medium-term' : 'Long-term'} planning</li>
                            </ul>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 10px;"> Strategic Recommendations</h3>
                            <div style="font-size: 14px; line-height: 1.6;">
                                ${period.includes('7') ? ' Short-term cash management focus. Plan daily operations and immediate cash needs.' : 
                                  period.includes('4') ? ' Medium-term planning period. Balance short and long-term cash requirements.' : 
                                  ' Long-term strategic planning. Focus on major investments and growth initiatives.'}
                                <br><br>
                                <strong>Action Items:</strong><br>
                                 Monitor daily cash flow vs forecast<br>
                                 Adjust plans based on ${riskLevel.toLowerCase()} risk level<br>
                                 Review performance weekly
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalHtml);
        }

        function showAnomalyDetails(severity, count) {
            // Get the anomaly data from the global scope or fetch it
            const anomalyData = window.currentAnomalyData || { anomalies: [] };
            const filteredAnomalies = anomalyData.anomalies.filter(anomaly => anomaly.severity === severity);
            
            const severityInfo = {
                'high': {
                    title: 'High Risk Anomalies',
                    icon: '',
                    color: 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)',
                    description: 'Critical issues requiring immediate attention',
                    bgColor: '#fff5f5',
                    borderColor: '#fed7d7'
                },
                'medium': {
                    title: 'Medium Risk Anomalies',
                    icon: '',
                    color: 'linear-gradient(135deg, #feca57 0%, #ff9ff3 100%)',
                    description: 'Suspicious patterns that need investigation',
                    bgColor: '#fffbeb',
                    borderColor: '#fef3c7'
                },
                'low': {
                    title: 'Low Risk Anomalies',
                    icon: '',
                    color: 'linear-gradient(135deg, #48dbfb 0%, #0abde3 100%)',
                    description: 'Minor deviations that may be normal',
                    bgColor: '#f0f9ff',
                    borderColor: '#bfdbfe'
                }
            };

            const info = severityInfo[severity];
            
            // Generate anomaly list HTML
            let anomaliesListHtml = '';
            if (filteredAnomalies.length > 0) {
                filteredAnomalies.forEach((anomaly, index) => {
                    const severityBadge = anomaly.severity === 'high' ? ' HIGH' : 
                                        anomaly.severity === 'medium' ? ' MEDIUM' : ' LOW';
                    
                    let transactionDetails = '';
                    if (anomaly.transaction) {
                        if (anomaly.transaction.amount) {
                            transactionDetails += `<div><strong>Amount:</strong> ${anomaly.transaction.amount.toLocaleString()}</div>`;
                        }
                        if (anomaly.transaction.date) {
                            transactionDetails += `<div><strong>Date:</strong> ${anomaly.transaction.date}</div>`;
                        }
                        if (anomaly.transaction.vendor) {
                            transactionDetails += `<div><strong>Vendor:</strong> ${anomaly.transaction.vendor}</div>`;
                        }
                        if (anomaly.transaction.frequency) {
                            transactionDetails += `<div><strong>Frequency:</strong> ${anomaly.transaction.frequency} times</div>`;
                        }
                        if (anomaly.transaction.uncategorized_count) {
                            transactionDetails += `<div><strong>Uncategorized:</strong> ${anomaly.transaction.uncategorized_count} transactions</div>`;
                        }
                        if (anomaly.transaction.percentage) {
                            transactionDetails += `<div><strong>Percentage:</strong> ${anomaly.transaction.percentage} of total</div>`;
                        }
                    }
                    
                    anomaliesListHtml += `
                        <div style="background: ${info.bgColor}; border: 1px solid ${info.borderColor}; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 16px; color: #333; margin-bottom: 5px;">
                                        ${anomaly.description}
                                    </div>
                                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                        ${anomaly.reason}
                                    </div>
                                </div>
                                <div style="background: ${info.color}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                                    ${severityBadge}
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 12px; margin-top: 10px;">
                                <div style="font-size: 13px; color: #555; line-height: 1.5;">
                                    <div style="margin-bottom: 5px;"><strong>Type:</strong> ${anomaly.type.replace('_', ' ').toUpperCase()}</div>
                                    ${transactionDetails}
                                </div>
                            </div>
                            
                            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-top: 10px; border-radius: 0 8px 8px 0;">
                                <div style="font-size: 12px; color: #1565c0; font-weight: bold; margin-bottom: 5px;"> Where to Check:</div>
                                <div style="font-size: 11px; color: #1976d2; line-height: 1.4;">
                                    ${anomaly.type === 'frequency_anomaly' ? `
                                         Check vendor master data for ${anomaly.transaction?.vendor || 'this vendor'}<br>
                                         Review transaction history for unusual patterns<br>
                                         Verify if vendor is legitimate or needs blocking
                                    ` : anomaly.type === 'time_anomaly' ? `
                                         Check system logs for ${anomaly.transaction?.date || 'this date'}<br>
                                         Review batch processing schedules<br>
                                         Verify if timing is normal for your operations
                                    ` : anomaly.type === 'amount_anomaly' ? `
                                         Check transaction details for ${anomaly.transaction?.amount?.toLocaleString() || 'this amount'}<br>
                                         Review vendor invoices and contracts<br>
                                         Verify payment authorization
                                    ` : anomaly.type === 'uncategorized_review' ? `
                                         Check SAP master data for vendor categorization<br>
                                         Review chart of accounts mapping<br>
                                         Update vendor master data with proper categories
                                    ` : `
                                         Review transaction details in SAP system<br>
                                         Check vendor master data<br>
                                         Verify with relevant departments
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                anomaliesListHtml = `
                    <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 30px; text-align: center; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">No ${severity} Risk Anomalies Found!</div>
                        <div style="font-size: 14px;">Your data looks clean and normal.</div>
                    </div>
                `;
            }

            const modalHtml = `
                <div id="detailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 95%; max-height: 85vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #333; margin: 0; font-size: 24px;">${info.icon} ${info.title}</h2>
                            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="background: ${info.color}; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px; font-size: 18px;"> Anomaly Summary</h3>
                            <div style="font-size: 16px; line-height: 1.6;">
                                <p><strong>Count:</strong> ${filteredAnomalies.length} anomalies</p>
                                <p><strong>Risk Level:</strong> ${severity.toUpperCase()}</p>
                                <p><strong>Status:</strong> ${info.description}</p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333; font-size: 18px; border-bottom: 2px solid ${info.color.split(',')[0].replace('linear-gradient(135deg, ', '').replace(' 0%', '')}; padding-bottom: 5px;">
                                 Detailed Anomaly List
                            </h3>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${anomaliesListHtml}
                            </div>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                            <h3 style="margin-bottom: 10px; color: #155724; font-size: 16px;"> Recommended Actions</h3>
                            <div style="font-size: 14px; line-height: 1.6; color: #155724;">
                                ${severity === 'high' ? `
                                    <p> <strong>Immediate Action Required:</strong> Review all high-risk transactions</p>
                                    <p> Investigate potential fraud, errors, or data quality issues</p>
                                    <p> Contact relevant departments for verification</p>
                                    <p> Consider blocking suspicious transactions if necessary</p>
                                ` : severity === 'medium' ? `
                                    <p> <strong>Monitor Closely:</strong> Review these patterns regularly</p>
                                    <p> Check vendor relationships and data quality</p>
                                    <p> Update categorization rules if needed</p>
                                    <p> Document findings for future reference</p>
                                ` : `
                                    <p> <strong>Review for Improvements:</strong> Consider data quality enhancements</p>
                                    <p> Update vendor master data if needed</p>
                                    <p> Monitor for pattern changes over time</p>
                                    <p> No immediate action required</p>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalHtml);
        }

        async function downloadFile(fileType) {
            try {
                const response = await fetch(`/download/${fileType}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    let filename;
                    if (fileType === 'vendor_cashflow_all') {
                        filename = `vendor_cashflow_analysis_${new Date().toISOString().split('T')[0]}.xlsx`;
                    } else {
                        filename = `${fileType}_category_breakdown_${new Date().toISOString().split('T')[0]}.xlsx`;
                    }
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showAlert('File downloaded successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert(`Download Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Download Error: ${error.message}`, 'error');
            }
        }

        // AP/AR Functions
        async function loadAPARDashboard() {
            try {
                showLoading(true);
                
                const response = await fetch('/ap_ar_dashboard');
                const data = await response.json();

                if (response.ok) {
                    displayAPARDashboard(data);
                } else {
                    showAlert(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadAPAnalysis() {
            try {
                showLoading(true);
                
                const response = await fetch('/ap_analysis');
                const data = await response.json();

                if (response.ok) {
                    displayAPAnalysis(data.ap_analysis);
                } else {
                    showAlert(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadARAnalysis() {
            try {
                showLoading(true);
                
                const response = await fetch('/ar_analysis');
                const data = await response.json();

                if (response.ok) {
                    displayARAnalysis(data.ar_analysis);
                } else {
                    showAlert(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function closeResults() {
            const resultsArea = document.getElementById('dashboardResultsArea');
            const resultsHeader = document.getElementById('resultsHeader');
            const backdrop = document.getElementById('dashboardBackdrop');
            resultsArea.classList.remove('show');
            backdrop.classList.remove('show');
            resultsHeader.style.display = 'none';
        }

        function displayAPARDashboard(data) {
            const resultsArea = document.getElementById('dashboardResultsArea');
            const resultsContent = document.getElementById('resultsContent');
            const resultsHeader = document.getElementById('resultsHeader');
            const resultsTitle = document.getElementById('resultsTitle');
            const dashboardSection = document.getElementById('apArDashboard');
            const summaryStats = document.getElementById('apArSummaryStats');
            
            // Safety check for required elements
            if (!summaryStats) {
                console.error('apArSummaryStats element not found');
                return;
            }
            
            // Display dashboard summary stats with clickable cards
            summaryStats.innerHTML = `
                <div onclick="showAPDetails('AP Outstanding', ${data.dashboard_summary.ap_summary.outstanding}, '${data.dashboard_summary.ap_summary.count || 0} transactions')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-credit-card stat-icon"></i>
                    <span class="stat-number">${formatAmount(data.dashboard_summary.ap_summary.outstanding)}</span>
                    <span class="stat-label">Outstanding AP</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showARDetails('AR Outstanding', ${data.dashboard_summary.ar_summary.outstanding}, '${data.dashboard_summary.ar_summary.count || 0} transactions')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-money-check-alt stat-icon"></i>
                    <span class="stat-number">${formatAmount(data.dashboard_summary.ar_summary.outstanding)}</span>
                    <span class="stat-label">Outstanding AR</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showTotalOutstandingDetails('Total Outstanding', ${data.dashboard_summary.critical_metrics.total_outstanding}, '${data.dashboard_summary.critical_metrics.total_transactions || 0} transactions')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-calculator stat-icon"></i>
                    <span class="stat-number">${formatAmount(data.dashboard_summary.critical_metrics.total_outstanding)}</span>
                    <span class="stat-label">Total Outstanding</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showEfficiencyDetails('Collection Efficiency', ${data.dashboard_summary.critical_metrics.collection_efficiency}, 'collection')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-percentage stat-icon"></i>
                    <span class="stat-number">${data.dashboard_summary.critical_metrics.collection_efficiency.toFixed(1)}%</span>
                    <span class="stat-label">Collection Efficiency</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showEfficiencyDetails('Payment Efficiency', ${data.dashboard_summary.critical_metrics.payment_efficiency}, 'payment')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-percentage stat-icon"></i>
                    <span class="stat-number">${data.dashboard_summary.critical_metrics.payment_efficiency.toFixed(1)}%</span>
                    <span class="stat-label">Payment Efficiency</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showOverdueDetails('90+ Days Overdue', ${data.dashboard_summary.critical_metrics.total_overdue_90plus}, '${data.dashboard_summary.critical_metrics.overdue_90plus_count || 0} transactions')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-exclamation-triangle stat-icon"></i>
                    <span class="stat-number">${formatAmount(data.dashboard_summary.critical_metrics.total_overdue_90plus)}</span>
                    <span class="stat-label">90+ Days Overdue</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
            `;
            
            dashboardSection.classList.remove('hidden');
            
            // Generate detailed dashboard content
            let content = generateAPARDashboardHTML(data);
            
            resultsTitle.textContent = 'AP/AR Dashboard';
            resultsContent.innerHTML = content;
            resultsHeader.style.display = 'flex';
            
            const backdrop = document.getElementById('dashboardBackdrop');
            backdrop.classList.add('show');
            resultsArea.classList.add('show');
            
            // Initialize tabs after content is loaded
            initializeAPARTabs();
        }

        function displayAPAnalysis(apData) {
            const resultsArea = document.getElementById('dashboardResultsArea');
            const resultsContent = document.getElementById('resultsContent');
            const resultsHeader = document.getElementById('resultsHeader');
            const resultsTitle = document.getElementById('resultsTitle');
            
            let content = generateAPAnalysisHTML(apData);
            
            resultsTitle.textContent = 'Accounts Payable Analysis';
            resultsContent.innerHTML = content;
            resultsHeader.style.display = 'flex';
            
            const backdrop = document.getElementById('dashboardBackdrop');
            backdrop.classList.add('show');
            resultsArea.classList.add('show');
            
            // Initialize tabs after content is loaded
            initializeAPARTabs();
        }

        function displayARAnalysis(arData) {
            const resultsArea = document.getElementById('dashboardResultsArea');
            const resultsContent = document.getElementById('resultsContent');
            const resultsHeader = document.getElementById('resultsHeader');
            const resultsTitle = document.getElementById('resultsTitle');
            
            let content = generateARAnalysisHTML(arData);
            
            resultsTitle.textContent = 'Accounts Receivable Analysis';
            resultsContent.innerHTML = content;
            resultsHeader.style.display = 'flex';
            
            const backdrop = document.getElementById('dashboardBackdrop');
            backdrop.classList.add('show');
            resultsArea.classList.add('show');
            
            // Initialize tabs after content is loaded
            initializeAPARTabs();
        }

        async function downloadAPAR(analysisType) {
            try {
                const response = await fetch(`/download_ap_ar/${analysisType}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ap_ar_${analysisType}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showAlert('AP/AR analysis downloaded successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert(`Download Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Download Error: ${error.message}`, 'error');
            }
        }

        // Invoice-Payment Functions
        async function runInvoicePaymentMatching() {
            try {
                showLoading(true);
                
                const response = await fetch('/invoice_payment_matching', {
                    method: 'POST'
                });
                
                const data = await response.json();

                if (response.ok) {
                    displayInvoicePaymentDashboard(data);
                    showAlert(`Invoice-payment matching completed successfully! Matched ${data.summary.matched_pairs} invoice-payment pairs.`, 'success');
                } else {
                    showAlert(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function viewInvoicePayments(matchType) {
            try {
                showLoading(true);
                const response = await fetch(`/view_invoice_payments/${matchType}`);
                const data = await response.json();

                if (response.ok) {
                    displayInvoicePaymentResults(data, matchType);
                } else {
                    showAlert(`Error: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error in viewInvoicePayments:', error);
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function downloadInvoicePayments(matchType) {
            try {
                const response = await fetch(`/download_invoice_payments/${matchType}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `invoice_payment_${matchType}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showAlert('Invoice-payment analysis downloaded successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert(`Download Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Download Error: ${error.message}`, 'error');
            }
        }

        function displayInvoicePaymentDashboard(data) {
            const dashboardSection = document.getElementById('invoicePaymentDashboard');
            const summaryStats = document.getElementById('invoicePaymentSummaryStats');
            
            // Safety check for required elements
            if (!summaryStats) {
                console.error('invoicePaymentSummaryStats element not found');
                return;
            }
            
            try {
                summaryStats.innerHTML = `
                    <div class="stat-card">
                        <i class="fas fa-link stat-icon"></i>
                        <span class="stat-number">${data.summary?.matched_pairs || 0}</span>
                        <span class="stat-label">Matched Pairs</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle stat-icon"></i>
                        <span class="stat-number">${data.summary?.unmatched_invoices || 0}</span>
                        <span class="stat-label">Outstanding Invoices</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-question-circle stat-icon"></i>
                        <span class="stat-number">${data.summary?.unmatched_payments || 0}</span>
                        <span class="stat-label">Orphaned Payments</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-percentage stat-icon"></i>
                        <span class="stat-number">${data.summary?.efficiency_percentage || 0}%</span>
                        <span class="stat-label">Payment Efficiency</span>
                    </div>
                `;
                
                if (dashboardSection) {
                    dashboardSection.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error displaying invoice payment dashboard:', error);
                showAlert('Error displaying dashboard. Please try again.', 'error');
            }
        }

        function displayInvoicePaymentResults(data, matchType) {
            const resultsArea = document.getElementById('dashboardResultsArea');
            const resultsContent = document.getElementById('resultsContent');
            const resultsHeader = document.getElementById('resultsHeader');
            const resultsTitle = document.getElementById('resultsTitle');
            
            // Check if all required elements exist
            if (!resultsArea || !resultsContent || !resultsHeader || !resultsTitle) {
                console.error('Missing required elements for invoice payment display');
                showAlert('Error: Required page elements not found. Please refresh the page.', 'error');
                return;
            }
            
            // Check if data is valid
            if (!data || typeof data !== 'object') {
                console.error('Invalid data received:', data);
                showAlert('Error: Invalid data received from server. Please try again.', 'error');
                return;
            }
            
            let content = '';
            let title = 'Invoice-Payment Analysis';
            
            try {
                if (data.type === 'invoice_payment_breakdown') {
                    content = generateInvoicePaymentBreakdownHTML(data, matchType);
                    title = 'Invoice-Payment Matched Pairs';
                } else if (data.type === 'unmatched_invoices_breakdown') {
                    content = generateUnmatchedInvoicesHTML(data);
                    title = 'Outstanding Invoices';
                } else if (data.type === 'unmatched_payments_breakdown') {
                    content = generateUnmatchedPaymentsHTML(data);
                    title = 'Orphaned Payments';
                } else if (data.type === 'efficiency_dashboard') {
                    content = generateEfficiencyDashboardHTML(data);
                    title = 'Payment Efficiency Dashboard';
                } else {
                    content = `<div class="alert alert-success"><i class="fas fa-check-circle"></i>Invoice-payment ${matchType} analysis completed successfully.</div>`;
                }
            } catch (error) {
                console.error('Error generating content:', error);
                content = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i>Error generating content. Please try again.</div>`;
                title = 'Invoice-Payment Analysis';
            }
            
            try {
                resultsTitle.textContent = title;
                resultsContent.innerHTML = content;
                resultsHeader.style.display = 'flex';
                
                const backdrop = document.getElementById('dashboardBackdrop');
                if (backdrop) {
                    backdrop.classList.add('show');
                }
                resultsArea.classList.add('show');
                
                if (typeof initializeInvoicePaymentTabs === 'function') {
                    initializeInvoicePaymentTabs();
                }
            } catch (error) {
                console.error('Error displaying invoice payment results:', error);
                showAlert('Error displaying results. Please try again.', 'error');
            }
        }

        async function debugInvoiceMatching() {
            try {
                showLoading(true);
                
                const response = await fetch('/debug_invoice_matching');
                const data = await response.json();

                if (response.ok) {
                    showAlert('Debug analysis completed. Check console for detailed information.', 'info');
                    console.log('Debug Info:', data);
                } else {
                    showAlert(`Debug Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Debug Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function analyzeOrphanedPayments() {
            try {
                showLoading(true);
                
                const response = await fetch('/analyze_orphaned_payments');
                const data = await response.json();

                if (response.ok) {
                    showAlert('Orphaned payments analysis completed successfully.', 'success');
                    console.log('Analysis Results:', data);
                } else {
                    showAlert(`Analysis Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Analysis Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Add all the missing HTML generation functions from your original code
        function generateAPARDashboardHTML(data) {
            return `
                <div class="tab-container">
                    <h3> Complete AP/AR Dashboard</h3>
                    
                    <!-- Critical Metrics Overview -->
                    <div class="alert alert-info">
                        <i class="fas fa-chart-pie"></i>
                        <div>
                            <h4> Critical Business Metrics</h4>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(data.dashboard_summary.critical_metrics.total_outstanding)}</span>
                                    <span class="stat-label">Total Outstanding</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${data.dashboard_summary.critical_metrics.collection_efficiency.toFixed(1)}%</span>
                                    <span class="stat-label">Collection Rate</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${data.dashboard_summary.critical_metrics.payment_efficiency.toFixed(1)}%</span>
                                    <span class="stat-label">Payment Rate</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(data.dashboard_summary.critical_metrics.total_overdue_90plus)}</span>
                                    <span class="stat-label">90+ Days Overdue</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AP/AR Tabs -->
                    <div class="tab-nav">
                        <button class="tab-button active" data-category="ap_overview">
                             AP Overview (${data.ap_analysis.outstanding_transactions} Outstanding)
                        </button>
                        <button class="tab-button" data-category="ar_overview">
                             AR Overview (${data.ar_analysis.outstanding_transactions} Outstanding)
                        </button>
                        <button class="tab-button" data-category="aging_analysis">
                             Aging Analysis
                        </button>
                        <button class="tab-button" data-category="cash_flow_impact">
                             Cash Flow Impact
                        </button>
                    </div>

                    <!-- AP Overview -->
                    <div class="tab-content active" data-category="ap_overview">
                        <h4> Accounts Payable Overview</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(data.ap_analysis.total_ap)}</span>
                                <span class="stat-label">Total AP</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(data.ap_analysis.outstanding_ap)}</span>
                                <span class="stat-label">Outstanding AP</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(data.ap_analysis.paid_ap)}</span>
                                <span class="stat-label">Paid AP</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${data.ap_analysis.outstanding_transactions}</span>
                                <span class="stat-label">Outstanding Count</span>
                            </div>
                        </div>
                        ${generateVendorBreakdownTable(data.ap_analysis.vendor_breakdown, 'Vendor Category')}
                    </div>

                    <!-- AR Overview -->
                    <div class="tab-content" data-category="ar_overview">
                        <h4> Accounts Receivable Overview</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(data.ar_analysis.total_ar)}</span>
                                <span class="stat-label">Total AR</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(data.ar_analysis.outstanding_ar)}</span>
                                <span class="stat-label">Outstanding AR</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(data.ar_analysis.received_ar)}</span>
                                <span class="stat-label">Received AR</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${data.ar_analysis.outstanding_transactions}</span>
                                <span class="stat-label">Outstanding Count</span>
                            </div>
                        </div>
                        ${generateVendorBreakdownTable(data.ar_analysis.customer_breakdown, 'Customer Category')}
                    </div>

                    <!-- Aging Analysis -->
                    <div class="tab-content" data-category="aging_analysis">
                        <h4> Combined Aging Analysis</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h5> AP Aging</h5>
                                ${generateAgingTable(data.ap_analysis.aging_analysis)}
                            </div>
                            <div>
                                <h5> AR Aging</h5>
                                ${generateAgingTable(data.ar_analysis.aging_analysis)}
                            </div>
                        </div>
                    </div>

                    <!-- Cash Flow Impact -->
                    <div class="tab-content" data-category="cash_flow_impact">
                        <h4> Cash Flow Impact Analysis</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(data.ap_ar_cash_flow.ap_net_flow)}</span>
                                <span class="stat-label">AP Net Cash Flow</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(data.ap_ar_cash_flow.ar_net_flow)}</span>
                                <span class="stat-label">AR Net Cash Flow</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(data.ap_ar_cash_flow.combined_net_flow)}</span>
                                <span class="stat-label">Combined Net Flow</span>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <h4> Cash Flow Insights</h4>
                                <ul>
                                    <li><strong>AP Impact:</strong> ${data.ap_ar_cash_flow.ap_net_flow < 0 ? 'Cash outflow' : 'Cash inflow'} of ${formatAmount(Math.abs(data.ap_ar_cash_flow.ap_net_flow))}</li>
                                    <li><strong>AR Impact:</strong> ${data.ap_ar_cash_flow.ar_net_flow < 0 ? 'Cash outflow' : 'Cash inflow'} of ${formatAmount(Math.abs(data.ap_ar_cash_flow.ar_net_flow))}</li>
                                    <li><strong>Net Effect:</strong> ${data.ap_ar_cash_flow.combined_net_flow < 0 ? 'Negative' : 'Positive'} cash flow of ${formatAmount(Math.abs(data.ap_ar_cash_flow.combined_net_flow))}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateAPAnalysisHTML(apData) {
            return `
                <div class="tab-container">
                    <h3> Accounts Payable Analysis</h3>
                    
                    <div class="alert alert-success">
                        <i class="fas fa-chart-bar"></i>
                        <div>
                            <h4> AP Summary</h4>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(apData.total_ap)}</span>
                                    <span class="stat-label">Total AP</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(apData.outstanding_ap)}</span>
                                    <span class="stat-label">Outstanding</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(apData.paid_ap)}</span>
                                    <span class="stat-label">Paid</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${apData.outstanding_transactions}</span>
                                    <span class="stat-label">Outstanding Count</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-nav">
                        <button class="tab-button active" data-category="ap_aging"> Aging Analysis</button>
                        <button class="tab-button" data-category="ap_vendors"> Vendor Breakdown</button>
                        <button class="tab-button" data-category="ap_status"> Status Breakdown</button>
                    </div>

                    <div class="tab-content active" data-category="ap_aging">
                        ${generateAgingTable(apData.aging_analysis)}
                    </div>

                    <div class="tab-content" data-category="ap_vendors">
                        ${generateVendorBreakdownTable(apData.vendor_breakdown, 'Vendor Category')}
                    </div>

                    <div class="tab-content" data-category="ap_status">
                        ${generateStatusBreakdownTable(apData.status_breakdown)}
                    </div>
                </div>
            `;
        }

        function generateARAnalysisHTML(arData) {
            return `
                <div class="tab-container">
                    <h3> Accounts Receivable Analysis</h3>
                    
                    <div class="alert alert-success">
                        <i class="fas fa-chart-line"></i>
                        <div>
                            <h4> AR Summary</h4>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(arData.total_ar)}</span>
                                    <span class="stat-label">Total AR</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(arData.outstanding_ar)}</span>
                                    <span class="stat-label">Outstanding</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${formatAmount(arData.received_ar)}</span>
                                    <span class="stat-label">Received</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-number">${arData.outstanding_transactions}</span>
                                    <span class="stat-label">Outstanding Count</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-nav">
                        <button class="tab-button active" data-category="ar_aging"> Aging Analysis</button>
                        <button class="tab-button" data-category="ar_customers"> Customer Breakdown</button>
                        <button class="tab-button" data-category="ar_status"> Status Breakdown</button>
                    </div>

                    <div class="tab-content active" data-category="ar_aging">
                        ${generateAgingTable(arData.aging_analysis)}
                    </div>

                    <div class="tab-content" data-category="ar_customers">
                        ${generateVendorBreakdownTable(arData.customer_breakdown, 'Customer Category')}
                    </div>

                    <div class="tab-content" data-category="ar_status">
                        ${generateStatusBreakdownTable(arData.status_breakdown)}
                    </div>
                </div>
            `;
        }

        function generateAgingTable(agingData) {
            let tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Age Period</th>
                            <th>Count</th>
                            <th>Amount</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const totalAmount = Object.values(agingData).reduce((sum, period) => sum + period.amount, 0);
            
            Object.entries(agingData).forEach(([period, data]) => {
                const percentage = totalAmount > 0 ? (data.amount / totalAmount * 100).toFixed(1) : 0;
                tableHtml += `
                    <tr>
                        <td>${period} days</td>
                        <td>${data.count}</td>
                        <td class="amount-${data.amount >= 0 ? 'positive' : 'negative'}">${formatAmount(data.amount)}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            return tableHtml;
        }

        function generateVendorBreakdownTable(vendorData, headerName) {
            let tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>${headerName}</th>
                            <th>Total Amount</th>
                            <th>Outstanding</th>
                            <th>Paid/Received</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.entries(vendorData).forEach(([vendor, data]) => {
                tableHtml += `
                    <tr>
                        <td>${vendor}</td>
                        <td class="amount-positive">${formatAmount(data.total_amount)}</td>
                        <td class="amount-negative">${formatAmount(data.outstanding_amount)}</td>
                        <td class="amount-positive">${formatAmount(data.paid_amount || data.received_amount)}</td>
                        <td>${data.transaction_count}</td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            return tableHtml;
        }

        function generateStatusBreakdownTable(statusData) {
            let tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Count</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.entries(statusData).forEach(([status, data]) => {
                tableHtml += `
                    <tr>
                        <td>${status}</td>
                        <td>${data.count}</td>
                        <td class="amount-${data.amount >= 0 ? 'positive' : 'negative'}">${formatAmount(data.amount)}</td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            return tableHtml;
        }
        
        // Initialize AP/AR tabs functionality
        function initializeAPARTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetCategory = this.dataset.category;
                    const parentContainer = this.closest('.tab-container');
                    
                    if (parentContainer) {
                        // Remove active class from all tabs and contents in this container
                        parentContainer.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
                        parentContainer.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        this.classList.add('active');
                        
                        // Show corresponding content
                        const targetContent = parentContainer.querySelector(`[data-category="${targetCategory}"].tab-content`);
                        if (targetContent) {
                            targetContent.classList.add('active');
                        }
                    }
                });
            });
        }

        // Add these functions right after initializeAPARTabs() function



function generateInvoicePaymentBreakdownHTML(data, matchType) {
    // Safety checks for data
    if (!data || typeof data !== 'object') {
        return '<div class="alert alert-error">Invalid data received</div>';
    }
    
    const breakdown = data.breakdown || {};
    const summary = data.summary || {};
    
    return `
        <div class="tab-container">
            <h3> Invoice-Payment Matched Pairs - Complete Breakdown</h3>
            
            <div class="alert alert-success">
                <i class="fas fa-link"></i>
                <div>
                    <h4> Matching Summary</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number">${summary.total_matched_pairs || 0}</span>
                            <span class="stat-label">Total Matched Pairs</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${formatAmount(summary.total_amount || 0)}</span>
                            <span class="stat-label">Total Amount</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${(summary.average_delay || 0).toFixed(1)}</span>
                            <span class="stat-label">Avg Delay (Days)</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${summary.operating_count || 0}</span>
                            <span class="stat-label">Operating</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${summary.investing_count || 0}</span>
                            <span class="stat-label">Investing</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${summary.financing_count || 0}</span>
                            <span class="stat-label">Financing</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-nav">
                <button class="tab-button active" data-category="Operating Activities">
                     Operating Activities (${breakdown['Operating Activities'].count})
                </button>
                <button class="tab-button" data-category="Investing Activities">
                     Investing Activities (${breakdown['Investing Activities'].count})
                </button>
                <button class="tab-button" data-category="Financing Activities">
                     Financing Activities (${breakdown['Financing Activities'].count})
                </button>
            </div>

            ${Object.keys(breakdown).map((category, index) => {
                const categoryData = breakdown[category];
                const isActive = index === 0 ? 'active' : '';
                
                return `
                    <div class="tab-content ${isActive}" data-category="${category}">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span class="stat-number">${categoryData.count}</span>
                                <span class="stat-label">Matched Pairs</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(categoryData.total_amount)}</span>
                                <span class="stat-label">Total Amount</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${categoryData.average_delay.toFixed(1)}</span>
                                <span class="stat-label">Avg Delay (Days)</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${categoryData.on_time_count}</span>
                                <span class="stat-label">On-Time Payments</span>
                            </div>
                        </div>
                        
                        ${generateInvoicePaymentTable(categoryData.transactions)}
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function generateUnmatchedInvoicesHTML(data) {
    const breakdown = data.breakdown;
    
    return `
        <div class="tab-container">
            <h3> Outstanding Invoices - No Payment Found</h3>
            
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <h4> Outstanding Summary</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number">${data.summary.total_unmatched_invoices}</span>
                            <span class="stat-label">Outstanding Invoices</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${formatAmount(data.summary.total_outstanding_amount)}</span>
                            <span class="stat-label">Total Outstanding Amount</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${data.summary.average_outstanding_days.toFixed(1)}</span>
                            <span class="stat-label">Avg Outstanding Days</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-nav">
                <button class="tab-button active" data-category="Operating Activities">
                     Operating Activities (${breakdown['Operating Activities'].count})
                </button>
                <button class="tab-button" data-category="Investing Activities">
                     Investing Activities (${breakdown['Investing Activities'].count})
                </button>
                <button class="tab-button" data-category="Financing Activities">
                     Financing Activities (${breakdown['Financing Activities'].count})
                </button>
            </div>

            ${Object.keys(breakdown).map((category, index) => {
                const categoryData = breakdown[category];
                const isActive = index === 0 ? 'active' : '';
                
                return `
                    <div class="tab-content ${isActive}" data-category="${category}">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span class="stat-number">${categoryData.count}</span>
                                <span class="stat-label">Outstanding Invoices</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${formatAmount(categoryData.total_amount)}</span>
                                <span class="stat-label">Total Amount</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">${categoryData.average_outstanding_days.toFixed(1)}</span>
                                <span class="stat-label">Avg Outstanding Days</span>
                            </div>
                        </div>
                        
                        ${generateInvoicePaymentTable(categoryData.transactions)}
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function generateUnmatchedPaymentsHTML(data) {
    const transactions = data.transactions;
    
    return `
        <div class="tab-container">
            <h3> Orphaned Payments - No Invoice Found</h3>
            
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <h4> Orphaned Summary</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number">${data.summary.total_unmatched_payments}</span>
                            <span class="stat-label">Orphaned Payments</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${formatAmount(data.summary.total_amount)}</span>
                            <span class="stat-label">Total Amount</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${data.summary.bank_payments}</span>
                            <span class="stat-label">Bank Payments</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${data.summary.sap_payments}</span>
                            <span class="stat-label">SAP Payments</span>
                        </div>
                    </div>
                </div>
            </div>
            
            ${generateInvoicePaymentTable(transactions)}
        </div>
    `;
}

function generateEfficiencyDashboardHTML(data) {
    const metrics = data.metrics;
    
    return `
        <div class="tab-container">
            <h3> Payment Efficiency Dashboard</h3>
            
            <div class="alert alert-info">
                <i class="fas fa-chart-line"></i>
                <div>
                    <h4> Efficiency Metrics</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number">${metrics.efficiency_percentage.toFixed(1)}%</span>
                            <span class="stat-label">Payment Efficiency</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${metrics.average_payment_delay.toFixed(1)}</span>
                            <span class="stat-label">Avg Payment Delay</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${metrics.on_time_payments}</span>
                            <span class="stat-label">On-Time Payments</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${metrics.late_payments}</span>
                            <span class="stat-label">Late Payments</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${metrics.very_late_payments}</span>
                            <span class="stat-label">Very Late (60+ days)</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${formatAmount(metrics.total_amount_matched)}</span>
                            <span class="stat-label">Total Amount Matched</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <h4> Payment Delay Distribution</h4>
            <div class="stats-grid">
                ${Object.entries(metrics.delay_distribution).map(([period, count]) => `
                    <div class="stat-card">
                        <span class="stat-number">${count}</span>
                        <span class="stat-label">${period}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function generateInvoicePaymentTable(transactions) {
    if (!transactions || transactions.length === 0) {
        return '<div class="alert alert-info"><i class="fas fa-info-circle"></i>No transactions found in this category.</div>';
    }
    
    let tableHtml = '<table class="data-table"><thead><tr>';
    
    // Check if this is invoice-payment data or other data
    if (transactions[0].hasOwnProperty('Invoice_Description')) {
        // Invoice-payment matched data
        tableHtml += `
            <th>Invoice Description</th>
            <th>Invoice Amount</th>
            <th>Payment Description</th>
            <th>Payment Amount</th>
            <th>Payment Delay</th>
            <th>Match Score</th>
            <th>Payment Source</th>
        `;
    } else if (transactions[0].hasOwnProperty('Payment_Description')) {
        // Unmatched payments
        tableHtml += `
            <th>Payment Description</th>
            <th>Payment Amount</th>
            <th>Payment Date</th>
            <th>Payment Source</th>
            <th>Reason</th>
        `;
    } else {
        // Unmatched invoices or general data
        tableHtml += `
            <th>Description</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Status</th>
            <th>Reason</th>
        `;
    }
    
    tableHtml += '</tr></thead><tbody>';
    
    // Generate rows
    transactions.forEach(transaction => {
        tableHtml += '<tr>';
        
        if (transaction.hasOwnProperty('Invoice_Description')) {
            // Invoice-payment matched data
            tableHtml += `
                <td>${transaction.Invoice_Description || ''}</td>
                <td class="${transaction.Invoice_Amount >= 0 ? 'amount-positive' : 'amount-negative'}">${formatAmount(transaction.Invoice_Amount || 0)}</td>
                <td>${transaction.Payment_Description || ''}</td>
                <td class="${transaction.Payment_Amount >= 0 ? 'amount-positive' : 'amount-negative'}">${formatAmount(transaction.Payment_Amount || 0)}</td>
                <td>${transaction.Payment_Delay_Days || 0} days</td>
                <td><span class="match-score">${(transaction.Match_Score || 0).toFixed(3)}</span></td>
                <td>${transaction.Payment_Source || 'Unknown'}</td>
            `;
        } else if (transaction.hasOwnProperty('Payment_Description')) {
            // Unmatched payments
            tableHtml += `
                <td>${transaction.Payment_Description || ''}</td>
                <td class="${transaction.Payment_Amount >= 0 ? 'amount-positive' : 'amount-negative'}">${formatAmount(transaction.Payment_Amount || 0)}</td>
                <td>${transaction.Payment_Date || ''}</td>
                <td>${transaction.Payment_Source || 'Unknown'}</td>
                <td>${transaction.Reason || ''}</td>
            `;
        } else {
            // Unmatched invoices or general data
            tableHtml += `
                <td>${transaction.Invoice_Description || transaction.Description || ''}</td>
                <td class="${(transaction.Invoice_Amount || transaction.Amount || 0) >= 0 ? 'amount-positive' : 'amount-negative'}">${formatAmount(transaction.Invoice_Amount || transaction.Amount || 0)}</td>
                <td>${transaction.Invoice_Date || transaction.Date || ''}</td>
                <td>${transaction.Invoice_Status || transaction.Status || ''}</td>
                <td>${transaction.Reason || ''}</td>
            `;
        }
        
        tableHtml += '</tr>';
    });
    
    tableHtml += '</tbody></table>';
    tableHtml += `<p style="margin-top: 10px; font-style: italic; color: #666;">Showing all ${transactions.length} transactions</p>`;
    
    return tableHtml;
}

function initializeInvoicePaymentTabs() {
    const tabs = document.querySelectorAll('.tab-button');
    const contents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetCategory = this.dataset.category;
            const parentContainer = this.closest('.tab-container');
            
            if (parentContainer) {
                // Remove active class from all tabs and contents in this container
                parentContainer.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
                parentContainer.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Show corresponding content
                const targetContent = parentContainer.querySelector(`[data-category="${targetCategory}"].tab-content`);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            }
        });
    });
}

async function checkStatus() {
    try {
        const response = await fetch('/status');
        const data = await response.json();
        
        if (response.ok) {
            console.log('System Status:', data);
            showAlert('System status checked successfully. See console for details.', 'info');
        } else {
            showAlert('Error checking system status', 'error');
        }
    } catch (error) {
        showAlert(`Status Error: ${error.message}`, 'error');
    }
}
async function runVendorAnalysis() {
    try {
        showLoading(true);
        showAlert('Running vendor cash flow analysis...', 'info');
        
        const response = await fetch('/vendor_cashflow');
        const data = await response.json();

        if (response.ok) {
            showAlert('Vendor cash flow analysis completed successfully!', 'success');
            displayVendorCashFlowDashboard(data);
            
            // Enable buttons
            const viewBtn = document.getElementById('viewAllVendorsBtn');
            const downloadBtn = document.getElementById('downloadAllVendorsBtn');
            const selectBox = document.getElementById('vendorSelect');
            
            if (viewBtn) viewBtn.disabled = false;
            if (downloadBtn) downloadBtn.disabled = false;
            if (selectBox) selectBox.disabled = false;
            
            // Load vendor list
            loadVendorList();
            
            console.log('Vendor analysis data:', data); // For debugging
        } else {
            showAlert(`Vendor analysis failed: ${data.error}`, 'error');
            console.error('Vendor analysis error:', data);
        }
    } catch (error) {
        showAlert(`Vendor analysis error: ${error.message}`, 'error');
        console.error('Vendor analysis exception:', error);
    } finally {
        showLoading(false);
    }
}


        function displayVendorCashFlowDashboard(data) {
            const dashboardSection = document.getElementById('vendorCashFlowDashboard');
            const summaryStats = document.getElementById('vendorCashFlowSummaryStats');
            
            // Safety check for required elements
            if (!summaryStats) {
                console.error('vendorCashFlowSummaryStats element not found');
                return;
            }
            
            const summary = data.summary_stats;
            
            summaryStats.innerHTML = `
                <div onclick="showVendorDetails('Total Vendors', ${summary.total_vendors_matched}, 'vendors')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-users stat-icon"></i>
                    <span class="stat-number">${summary.total_vendors_matched}</span>
                    <span class="stat-label">Total Vendors</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showTransactionDetails('Total Transactions', ${summary.total_transactions_analyzed}, 'transactions')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-exchange-alt stat-icon"></i>
                    <span class="stat-number">${summary.total_transactions_analyzed}</span>
                    <span class="stat-label">Total Transactions</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showAmountDetails('Total Amount', ${summary.total_amount_all_vendors}, 'amount')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-dollar-sign stat-icon"></i>
                    <span class="stat-number">${formatAmount(summary.total_amount_all_vendors)}</span>
                    <span class="stat-label">Total Amount</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
                <div onclick="showAIDetails('AI Status', '${summary.ai_enabled ? 'Enabled' : 'Disabled'}', 'ai')" 
                     class="stat-card" style="cursor: pointer; transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <i class="fas fa-robot stat-icon"></i>
                    <span class="stat-number">${summary.ai_enabled ? 'Yes' : 'No'}</span>
                    <span class="stat-label">AI Enabled</span>
                    <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;"> Click for details</div>
                </div>
            `;
            
            dashboardSection.classList.remove('hidden');
        }

async function loadVendorList() {
    try {
        console.log('Loading vendor list...');
        const response = await fetch('/vendor_list');
        const data = await response.json();
        
        console.log('Vendor list response:', data);
        
        if (response.ok && data.status === 'success') {
            const select = document.getElementById('vendorSelect');
            if (!select) {
                console.error('Vendor select element not found');
                return;
            }
            
            select.innerHTML = '<option value="">Choose a vendor...</option>';
            
            if (data.vendors && data.vendors.length > 0) {
                // Sort vendors alphabetically by name
                const sortedVendors = data.vendors.sort((a, b) => 
                    a.vendor_name.localeCompare(b.vendor_name)
                );
                
                sortedVendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor.vendor_name;
                    // Show only vendor name and category, no money amounts
                    option.textContent = `${vendor.vendor_name} (${vendor.category})`;
                    select.appendChild(option);
                });
                
                showAlert(`Loaded ${data.vendors.length} vendors for selection`, 'success');
                console.log(`Loaded ${data.vendors.length} vendors`);
            } else {
                showAlert('No vendors found in analysis', 'warning');
            }
        } else {
            showAlert(`Error loading vendor list: ${data.error || 'Unknown error'}`, 'error');
            console.error('Vendor list error:', data);
        }
    } catch (error) {
        showAlert(`Error loading vendor list: ${error.message}`, 'error');
        console.error('Vendor list exception:', error);
    }
}

        async function viewIndividualVendor() {
            const vendorName = document.getElementById('vendorSelect').value;
            if (!vendorName) return;
            
            try {
                showLoading(true);
                
                const response = await fetch(`/view_vendor_cashflow/${encodeURIComponent(vendorName)}`);
                const data = await response.json();

                if (response.ok) {
                    displayCategoryBreakdown(data, `vendor_${vendorName}`);
                } else {
                    showAlert(`Error loading vendor cash flow: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Error loading vendor cash flow: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Advanced Features Functions
        function toggleFilters() {
            showDashboardResults('Advanced Filters', `
                <div class="filters-content">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>Date Range</label>
                            <div class="date-inputs">
                                <input type="date" id="startDate" class="filter-input">
                                <span>to</span>
                                <input type="date" id="endDate" class="filter-input">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>Amount Range</label>
                            <div class="amount-inputs">
                                <input type="number" id="minAmount" placeholder="Min Amount" class="filter-input">
                                <span>to</span>
                                <input type="number" id="maxAmount" placeholder="Max Amount" class="filter-input">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>Category</label>
                            <select id="categoryFilter" class="filter-input">
                                <option value="">All Categories</option>
                                <option value="Operating Activities">Operating Activities</option>
                                <option value="Investing Activities">Investing Activities</option>
                                <option value="Financing Activities">Financing Activities</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Search</label>
                            <input type="text" id="searchFilter" placeholder="Search transactions..." class="filter-input">
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search"></i>
                            Apply Filters
                        </button>
                        <button class="btn btn-outline" onclick="clearFilters()">
                            <i class="fas fa-undo"></i>
                            Clear All
                        </button>
                    </div>
                </div>
            `);
        }

        function toggleCharts() {
            showDashboardResults('Analytics Dashboard', `
                <div class="charts-content">
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Category Distribution</h3>
                            <canvas id="categoryChart" width="400" height="300"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Monthly Trends</h3>
                            <canvas id="trendsChart" width="400" height="300"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Reconciliation Status</h3>
                            <canvas id="statusChart" width="400" height="300"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Cash Flow Analysis</h3>
                            <canvas id="cashFlowChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            `);
            // Initialize charts after content is loaded
            setTimeout(() => {
                initializeCharts();
            }, 100);
        }

        function toggleAnalytics() {
            showDashboardResults('Advanced Analytics', `
                <div class="analytics-content">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3>Performance Metrics</h3>
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <div class="metric-label">Reconciliation Rate</div>
                                    <div class="metric-value">94.2%</div>
                                    <div class="metric-trend positive">
                                        <i class="fas fa-arrow-up"></i>
                                        +2.1%
                                    </div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Processing Time</div>
                                    <div class="metric-value">1.8s</div>
                                    <div class="metric-trend negative">
                                        <i class="fas fa-arrow-down"></i>
                                        -0.3s
                                    </div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Accuracy Rate</div>
                                    <div class="metric-value">98.7%</div>
                                    <div class="metric-trend positive">
                                        <i class="fas fa-arrow-up"></i>
                                        +0.5%
                                    </div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Error Rate</div>
                                    <div class="metric-value">1.3%</div>
                                    <div class="metric-trend negative">
                                        <i class="fas fa-arrow-down"></i>
                                        -0.2%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3>Trend Analysis</h3>
                            <div class="trend-analysis">
                                <div class="trend-item">
                                    <div class="trend-header">
                                        <span class="trend-label">Monthly Growth</span>
                                        <span class="trend-value positive">+12.5%</span>
                                    </div>
                                    <div class="trend-bar">
                                        <div class="trend-fill" style="width: 75%"></div>
                                    </div>
                                </div>
                                <div class="trend-item">
                                    <div class="trend-header">
                                        <span class="trend-label">Efficiency Score</span>
                                        <span class="trend-value positive">+8.3%</span>
                                    </div>
                                    <div class="trend-bar">
                                        <div class="trend-fill" style="width: 83%"></div>
                                    </div>
                                </div>
                                <div class="trend-item">
                                    <div class="trend-header">
                                        <span class="trend-label">Cost Savings</span>
                                        <span class="trend-value positive">+15.2%</span>
                                    </div>
                                    <div class="trend-bar">
                                        <div class="trend-fill" style="width: 92%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <h3>Predictive Insights</h3>
                            <div class="insights-list">
                                <div class="insight-item">
                                    <div class="insight-icon warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="insight-content">
                                        <h4>Potential Discrepancy Alert</h4>
                                        <p>Based on historical patterns, 3 transactions may require manual review within 24 hours.</p>
                                    </div>
                                </div>
                                <div class="insight-item">
                                    <div class="insight-icon info">
                                        <i class="fas fa-lightbulb"></i>
                                    </div>
                                    <div class="insight-content">
                                        <h4>Optimization Opportunity</h4>
                                        <p>Automated matching rate could improve by 5% with additional keyword training.</p>
                                    </div>
                                </div>
                                <div class="insight-item">
                                    <div class="insight-icon success">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="insight-content">
                                        <h4>Performance Forecast</h4>
                                        <p>Expected to process 15% more transactions next month based on current trends.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <h3>System Health</h3>
                            <div class="health-metrics">
                                <div class="health-item">
                                    <div class="health-label">CPU Usage</div>
                                    <div class="health-bar">
                                        <div class="health-fill" style="width: 45%"></div>
                                    </div>
                                    <div class="health-value">45%</div>
                                </div>
                                <div class="health-item">
                                    <div class="health-label">Memory Usage</div>
                                    <div class="health-bar">
                                        <div class="health-fill" style="width: 62%"></div>
                                    </div>
                                    <div class="health-value">62%</div>
                                </div>
                                <div class="health-item">
                                    <div class="health-label">Database Performance</div>
                                    <div class="health-bar">
                                        <div class="health-fill" style="width: 78%"></div>
                                    </div>
                                    <div class="health-value">78%</div>
                                </div>
                                <div class="health-item">
                                    <div class="health-label">Network Latency</div>
                                    <div class="health-bar">
                                        <div class="health-fill" style="width: 23%"></div>
                                    </div>
                                    <div class="health-value">23ms</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        function initializeCharts() {
            // Category Distribution Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Operating Activities', 'Investing Activities', 'Financing Activities'],
                    datasets: [{
                        data: [60, 25, 15],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Monthly Trends Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Transactions',
                        data: [1200, 1350, 1100, 1400, 1600, 1800],
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Reconciliation Status Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'bar',
                data: {
                    labels: ['Reconciled', 'Pending', 'Unmatched'],
                    datasets: [{
                        label: 'Count',
                        data: [850, 120, 30],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Cash Flow Analysis Chart
            const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
            new Chart(cashFlowCtx, {
                type: 'bar',
                data: {
                    labels: ['Operating', 'Investing', 'Financing'],
                    datasets: [{
                        label: 'Cash Flow',
                        data: [2500000, -800000, -500000],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const minAmount = document.getElementById('minAmount').value;
            const maxAmount = document.getElementById('maxAmount').value;
            const category = document.getElementById('categoryFilter').value;
            const search = document.getElementById('searchFilter').value;

            // Here you would apply the filters to your data
            showAlert('Filters applied successfully!', 'success');
            
            // For now, just show a success message
            // In a real implementation, you would filter the data and update the display
        }

        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('minAmount').value = '';
            document.getElementById('maxAmount').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            showAlert('All filters cleared!', 'info');
        }

        function exportData() {
            showDashboardResults('Export Data', `
                <div class="export-content">
                    <div class="export-options">
                        <h3>Select Export Options</h3>
                        <div class="export-grid">
                            <div class="export-option">
                                <input type="checkbox" id="exportSummary" checked>
                                <label for="exportSummary">Dashboard Summary</label>
                            </div>
                            <div class="export-option">
                                <input type="checkbox" id="exportTransactions" checked>
                                <label for="exportTransactions">Transaction Data</label>
                            </div>
                            <div class="export-option">
                                <input type="checkbox" id="exportAnalytics">
                                <label for="exportAnalytics">Analytics Reports</label>
                            </div>
                            <div class="export-option">
                                <input type="checkbox" id="exportCharts">
                                <label for="exportCharts">Chart Data</label>
                            </div>
                        </div>
                        
                        <div class="export-format">
                            <h4>Export Format</h4>
                            <select id="exportFormat" class="filter-input">
                                <option value="json">JSON</option>
                                <option value="csv">CSV</option>
                                <option value="excel">Excel</option>
                                <option value="pdf">PDF</option>
                            </select>
                        </div>
                        
                        <div class="export-actions">
                            <button class="btn btn-primary" onclick="performExport()">
                                <i class="fas fa-download"></i>
                                Export Data
                            </button>
                            <button class="btn btn-outline" onclick="closeResults()">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `);
        }

        function performExport() {
            const format = document.getElementById('exportFormat').value;
            const includeSummary = document.getElementById('exportSummary').checked;
            const includeTransactions = document.getElementById('exportTransactions').checked;
            const includeAnalytics = document.getElementById('exportAnalytics').checked;
            const includeCharts = document.getElementById('exportCharts').checked;

            // Create export data
            const data = {
                summary: includeSummary ? {
                    totalTransactions: document.getElementById('totalTransactions').textContent,
                    reconciledAmount: document.getElementById('reconciledAmount').textContent,
                    pendingReviews: document.getElementById('pendingReviews').textContent,
                    activeUsers: document.getElementById('activeUsers').textContent
                } : null,
                transactions: includeTransactions ? [] : null,
                analytics: includeAnalytics ? {} : null,
                charts: includeCharts ? {} : null,
                timestamp: new Date().toISOString()
            };

            // Create and download file
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reconciliation_report_${new Date().toISOString().split('T')[0]}.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            closeResults();
            showAlert('Data exported successfully!', 'success');
        }

        function refreshData() {
            showDashboardResults('Refresh Data', `
                <div class="refresh-content">
                    <div class="refresh-status">
                        <h3>Data Refresh Status</h3>
                        <div class="refresh-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="refreshProgress" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="refreshStatus">Initializing refresh...</div>
                        </div>
                        
                        <div class="refresh-steps">
                            <div class="refresh-step" id="step1">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Connecting to database...</span>
                            </div>
                            <div class="refresh-step" id="step2">
                                <i class="fas fa-clock"></i>
                                <span>Fetching latest transactions...</span>
                            </div>
                            <div class="refresh-step" id="step3">
                                <i class="fas fa-clock"></i>
                                <span>Updating analytics...</span>
                            </div>
                            <div class="refresh-step" id="step4">
                                <i class="fas fa-clock"></i>
                                <span>Finalizing refresh...</span>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            // Simulate refresh process
            simulateRefresh();
        }

        function simulateRefresh() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            const progress = document.getElementById('refreshProgress');
            const status = document.getElementById('refreshStatus');
            
            let currentStep = 0;
            const interval = setInterval(() => {
                if (currentStep < steps.length) {
                    // Update progress
                    const percent = ((currentStep + 1) / steps.length) * 100;
                    progress.style.width = percent + '%';
                    
                    // Update step status
                    const stepElement = document.getElementById(steps[currentStep]);
                    if (stepElement) {
                        stepElement.innerHTML = '<i class="fas fa-check text-success"></i><span>Completed</span>';
                    }
                    
                    // Update status text
                    const statusTexts = [
                        'Connected to database successfully',
                        'Fetched 1,247 transactions',
                        'Updated analytics and charts',
                        'Refresh completed successfully'
                    ];
                    status.textContent = statusTexts[currentStep];
                    
                    currentStep++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        closeResults();
                        showAlert('Data refreshed successfully!', 'success');
                    }, 1000);
                }
            }, 800);
        }

        // Lazy loading for performance
        function initializeLazyLoading() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('loaded');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.1
            });

            // Observe all sections for lazy loading
            document.querySelectorAll('.section-card, .summary-card, .analytics-card').forEach(el => {
                el.classList.add('lazy-load');
                observer.observe(el);
            });
        }

        // Performance monitoring
        function initializePerformanceMonitoring() {
            // Monitor page load time
            window.addEventListener('load', () => {
                const loadTime = performance.now();
                console.log(`Page loaded in ${loadTime.toFixed(2)}ms`);
                
                if (loadTime > 3000) {
                    addNotification('Page load time is slower than expected', 'warning');
                }
            });

            // Monitor memory usage (simulated)
            setInterval(() => {
                const memoryUsage = Math.random() * 100;
                if (memoryUsage > 80) {
                    addNotification('High memory usage detected', 'warning');
                }
            }, 60000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + F to toggle filters
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                toggleFilters();
            }
            
            // Ctrl/Cmd + C to toggle charts
            if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                e.preventDefault();
                toggleCharts();
            }
            
            // Ctrl/Cmd + E to export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportData();
            }
            
            // Ctrl/Cmd + R to refresh
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                const resultsArea = document.getElementById('dashboardResultsArea');
                if (resultsArea.classList.contains('show')) {
                    closeResults();
                }
            }
        });

        // Real-time Updates and Notifications
        let notificationCount = 0;
        let realTimeInterval;

        function initializeRealTimeUpdates() {
            // Start real-time updates every 30 seconds
            realTimeInterval = setInterval(() => {
                updateDashboardData();
            }, 30000);

            // Simulate initial notifications
            setTimeout(() => {
                addNotification('New transactions detected', 'info');
            }, 5000);

            setTimeout(() => {
                addNotification('Reconciliation completed for 15 transactions', 'success');
            }, 10000);

            setTimeout(() => {
                addNotification('System maintenance scheduled for tonight', 'warning');
            }, 15000);
        }

        function updateDashboardData() {
            // Simulate real-time data updates
            const transactions = Math.floor(Math.random() * 50) + 1000;
            const reconciled = Math.floor(Math.random() * 100) + 800;
            const pending = Math.floor(Math.random() * 20) + 100;
            const users = Math.floor(Math.random() * 5) + 15;

            document.getElementById('totalTransactions').textContent = transactions.toLocaleString();
            document.getElementById('reconciledAmount').textContent = reconciled.toLocaleString();
            document.getElementById('pendingReviews').textContent = pending.toLocaleString();
            document.getElementById('activeUsers').textContent = users.toLocaleString();

            // Add notification for significant changes
            if (Math.random() > 0.7) {
                addNotification('Dashboard data updated', 'info');
            }
        }

        function addNotification(message, type = 'info') {
            notificationCount++;
            
            const notificationList = document.getElementById('notificationList');
            const notificationBadge = document.getElementById('notificationBadge');
            
            const notification = document.createElement('div');
            notification.className = `notification-item ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">
                        <i class="fas ${getNotificationIcon(type)}"></i>
                    </div>
                    <div class="notification-text">
                        <p>${message}</p>
                        <small>${new Date().toLocaleTimeString()}</small>
                    </div>
                </div>
                <button class="notification-close" onclick="removeNotification(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;

            notificationList.insertBefore(notification, notificationList.firstChild);
            notificationBadge.textContent = notificationCount;

            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    removeNotification(notification.querySelector('.notification-close'));
                }
            }, 10000);
        }

        function removeNotification(button) {
            const notification = button.closest('.notification-item');
            notification.remove();
            notificationCount = Math.max(0, notificationCount - 1);
            document.getElementById('notificationBadge').textContent = notificationCount;
        }

        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        // Check AI/ML status
        async function checkAIMLStatus() {
            try {
                const response = await fetch('/test-ml-models');
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(` AI/ML Models Working! ${data.models_used.length} models active, ${data.features_used} features`, 'success');
                    console.log('AI/ML Status:', data);
                } else {
                    showAlert(` AI/ML Models Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert(' Cannot check AI/ML status. Server not running?', 'error');
            }
        }

        // Download anomaly detection report
        async function downloadAnomalyReport() {
            try {
                showAlert(' Generating anomaly detection report...', 'info');
                
                const response = await fetch('/download-anomaly-report');
                
                if (response.ok) {
                    // Get the filename from the response headers
                    const contentDisposition = response.headers.get('content-disposition');
                    let filename = 'Anomaly_Detection_Report.xlsx';
                    
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }
                    
                    // Create blob and download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showAlert(` Report downloaded: ${filename}`, 'success');
                } else {
                    const errorData = await response.json();
                    showAlert(` Download failed: ${errorData.message}`, 'error');
                }
            } catch (error) {
                console.error('Download error:', error);
                showAlert(' Download failed. Please try again.', 'error');
            }
        }

        function toggleNotificationCenter() {
            const center = document.getElementById('notificationCenter');
            center.classList.toggle('show');
        }

        // Initialize all features when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize core functionality first
            initializeEventListeners();
            showWelcomeMessage();
            
            // Then initialize additional features
            initializeRealTimeUpdates();
            initializeLazyLoading();
            initializePerformanceMonitoring();
            
            // Add welcome notification
            setTimeout(() => {
                addNotification('Welcome to the enhanced SAP-Bank Reconciliation Platform!', 'success');
            }, 1000);
        });
    </script>

    <!-- Real-time Notification Center -->
    <div id="notificationCenter" class="notification-center">
        <div class="notification-header">
            <h3><i class="fas fa-bell"></i> Notifications</h3>
            <button class="btn-close" onclick="toggleNotificationCenter()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be added here dynamically -->
        </div>
    </div>

    <!-- Notification Toggle Button -->
    <button id="notificationToggle" class="notification-toggle" onclick="toggleNotificationCenter()">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationBadge">0</span>
    </button>
</body>
</html>
